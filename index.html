<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - E-commerce Elegante</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        /* Estilos Globais e Fundo */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #f4f4f4 0%, #ffffff 100%);
            padding-top: 70px; /* Espaço para o navbar fixo */
        }
        
        /* Navbar */
        .navbar-custom {
            background-color: #1a1a1a !important; /* Fundo escuro */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand, .nav-link, .btn-link {
            color: #ffffff !important;
        }
        .nav-link:hover, .btn-link:hover {
            color: #28a745 !important; /* Destaque verde */
        }

        /* Seções */
        .section {
            display: none;
            padding: 30px 0;
            animation: fadeIn 0.5s ease-out;
        }
        .section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Produtos */
        .product-card-custom {
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #eee;
        }
        .product-card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1) !important;
        }
        .product-card-custom img {
            height: 200px;
            object-fit: cover;
            border-radius: 4px 4px 0 0;
        }
        .btn-add-to-cart {
            background-color: #1a1a1a;
            border-color: #1a1a1a;
            transition: background-color 0.3s;
        }
        .btn-add-to-cart:hover {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-add-to-cart.btn-added {
            background-color: #28a745;
            border-color: #28a745;
        }
        .cart-count-pulse {
            animation: pulse 0.5s 2;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Swiper/Carrossel */
        .swiper-container {
            padding-top: 20px;
            margin-bottom: 30px;
            display: none;
        }
        .swiper-container.active {
            display: block;
        }
        .swiper-slide {
            height: 300px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        .slide-content {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
        }

        /* Formulários e Mensagens */
        .form-container {
            max-width: 450px;
            margin: 0 auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .form-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn-google {
            background-color: #4285f4;
            color: white;
            border: none;
            transition: background-color 0.3s;
        }
        .btn-google:hover {
            background-color: #357ae8;
        }
        .g-recaptcha {
            margin-bottom: 15px;
            transform: scale(0.9);
            transform-origin: 0 0;
        }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-custom">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#" onclick="showSection('products')">
                <i class="bi bi-shop"></i> Minha Loja
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('products')">Produtos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showSection('cart')">Carrinho</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <button class="btn btn-link nav-link me-3" id="show-cart-btn" onclick="updateCart()">
                        <i class="bi bi-cart"></i> Carrinho (<span id="cart-count">0</span>)
                    </button>
                    
                    <button class="btn btn-outline-light me-2" id="show-account-btn" style="display: none;">
                        <i class="bi bi-person-circle"></i> Minha Conta
                    </button>
                    
                    <button class="btn btn-outline-light me-2" id="show-login-btn">
                        <i class="bi bi-box-arrow-in-right"></i> Entrar
                    </button>
                    
                    <button class="btn btn-outline-danger" id="logout-btn" style="display: none;">
                        <i class="bi bi-box-arrow-right"></i> Sair
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="container my-5">

        <div class="swiper-container mySwiper active">
            <div class="swiper-wrapper">
                <div class="swiper-slide" style="background-image: url('images/banner1.jpg');">
                    <div class="slide-content text-center">
                        <h2 class="display-5 fw-bold">Grandes Ofertas</h2>
                        <p class="lead">Qualidade premium com preços imbatíveis. Aproveite!</p>
                    </div>
                </div>
                <div class="swiper-slide" style="background-image: url('images/banner2.jpg');">
                    <div class="slide-content text-center">
                        <h2 class="display-5 fw-bold">Tecnologia de Ponta</h2>
                        <p class="lead">Os últimos lançamentos do mercado estão aqui.</p>
                    </div>
                </div>
            </div>
            <div class="swiper-pagination"></div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
        </div>

        <section id="products-section" class="section active">
            <h2 class="text-center mb-4 display-6 fw-bold">Nossos Produtos em Destaque</h2>
            <div id="product-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                </div>
        </section>

        <section id="cart-section" class="section">
            <h2 class="text-center mb-4 display-6 fw-bold">Seu Carrinho de Compras</h2>
            <div class="row">
                <div class="col-lg-8">
                    <div class="list-group" id="cart-items">
                        </div>
                </div>
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="card shadow-sm rounded-4">
                        <div class="card-body">
                            <h3 class="card-title h4">Resumo do Pedido</h3>
                            <p class="fs-4 fw-bold mt-3">Total: R$ <span id="cart-total">0.00</span></p>
                            <button id="checkout-btn" class="btn btn-success w-100 btn-lg fw-bold mt-3" disabled>
                                Finalizar Compra <i class="bi bi-credit-card-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="login-section" class="section">
            <div class="form-container">
                <h2 class="text-center mb-4 display-6 fw-bold">Acessar Conta</h2>
                
                <div id="google-login-container" class="mb-3 d-flex justify-content-center">
                    <div id="g_id_onload"
                        data-client_id="COLOQUE_SEU_CLIENT_ID_DO_GOOGLE_AQUI.apps.googleusercontent.com"
                        data-context="signin"
                        data-ux_mode="popup"
                        data-callback="handleCredentialResponse"
                        data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                        data-type="standard"
                        data-shape="pill"
                        data-theme="outline"
                        data-text="signin_with"
                        data-size="large"
                        data-logo_alignment="left">
                    </div>
                </div>

                <div class="text-center mb-3 text-muted">ou acesse com e-mail e senha</div>

                <form id="login-form">
                    <div class="mb-3">
                        <label for="login-email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="login-email" required value="">
                    </div>
                    <div class="mb-3">
                        <label for="login-password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="login-password" required value="">
                    </div>
                    
                    <div class="g-recaptcha" data-sitekey="COLOQUE_SUA_CHAVE_SITE_DO_RECAPTCHA_AQUI" data-callback="enableLoginButtons" data-expired-callback="disableLoginButtons"></div>
                    
                    <button id="submit-login-btn" type="submit" class="btn btn-dark w-100 fw-bold" disabled>Entrar</button>
                </form>

                <div id="login-message" class="form-message"></div>

                <div class="text-center mt-3">
                    <p class="mb-0">Não tem conta? <a href="#" id="show-register-btn" class="text-success fw-bold">Cadastre-se</a></p>
                </div>
            </div>
        </section>

        <section id="register-section" class="section">
            <div class="form-container">
                <h2 class="text-center mb-4 display-6 fw-bold">Novo Cadastro</h2>
                <form id="register-form">
                    <div class="mb-3">
                        <label for="register-name" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="register-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="register-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="register-password" class="form-label">Senha (mín. 6 caracteres)</label>
                        <input type="password" class="form-control" id="register-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-success w-100 fw-bold">Registrar</button>
                </form>
                <div id="register-message" class="form-message"></div>
            </div>
        </section>

        <section id="account-section" class="section">
            <h2 class="text-center mb-4 display-6 fw-bold">Minha Conta</h2>
            <div class="row">
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm rounded-4">
                        <div class="card-body">
                            <h3 class="card-title h4 text-primary"><i class="bi bi-person-fill"></i> Dados Pessoais</h3>
                            <hr>
                            <p class="mb-1"><strong>Nome:</strong> <span id="account-name"></span></p>
                            <p><strong>E-mail:</strong> <span id="account-email"></span></p>
                            <button class="btn btn-outline-danger btn-sm" id="logout-btn-2">Sair da Conta</button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8 mb-4" id="change-password-section">
                    <div class="card shadow-sm rounded-4">
                        <div class="card-body">
                            <h3 class="card-title h4"><i class="bi bi-lock-fill"></i> Alterar Senha</h3>
                            <hr>
                            <form id="change-password-form">
                                <div class="mb-3" id="current-password-container">
                                    <label for="current-password" class="form-label">Senha Atual</label>
                                    <input type="password" class="form-control" id="current-password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new-password" class="form-label">Nova Senha (mín. 6 caracteres)</label>
                                    <input type="password" class="form-control" id="new-password" required minlength="6">
                                </div>
                                <button type="submit" class="btn btn-dark fw-bold">Salvar Nova Senha</button>
                            </form>
                            <div id="password-message" class="form-message mt-3"></div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm rounded-4">
                        <div class="card-body">
                            <h3 class="card-title h4"><i class="bi bi-receipt"></i> Histórico de Compras</h3>
                            <hr>
                            <div id="purchase-list" class="list-group">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="checkout-section" class="section">
            <div class="form-container text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                <h2 class="mt-3 display-6 fw-bold text-success">Compra Finalizada com Sucesso!</h2>
                <p class="lead mt-3">Sua compra foi salva no nosso sistema e um e-mail de confirmação foi enviado para:</p>
                <p class="fs-4 fw-bold text-dark" id="account-email-checkout"></p>
                <p class="text-muted small">Por favor, note que esta é uma simulação de e-commerce e nenhum produto real será entregue. Agradecemos sua participação!</p>
                <button class="btn btn-dark mt-4 fw-bold" onclick="showSection('products')">
                    Voltar para a Loja <i class="bi bi-house-door-fill"></i>
                </button>
            </div>
        </section>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Lista de Produtos Estática
        const products = [
            { id: 1, name: 'Notebook Pro', price: 2500.00, image: 'notebook.jpg' },
            { id: 2, name: 'Fone de Ouvido sem Fio', price: 350.50, image: 'fone.jpg' },
            { id: 3, name: 'Relógio Inteligente', price: 800.00, image: 'relogio.jpg' },
            { id: 4, name: 'Kit de Canetas', price: 45.90, image: 'canetas.jpg' },
            { id: 5, name: 'Planta Decorativa', price: 120.00, image: 'planta.jpg' },
            { id: 6, name: 'Livro', price: 75.00, image: 'livro.jpg' },
        ];
        
        // Estado do Carrinho (Persistência Local)
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        // Estado do Usuário Logado (Persistência de Sessão)
        let loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser')); 

        // Referências DOM
        const productListEl = document.getElementById('product-list');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const swiperContainer = document.querySelector('.swiper-container');
        
        const sections = {
            products: document.getElementById('products-section'),
            cart: document.getElementById('cart-section'),
            login: document.getElementById('login-section'),
            register: document.getElementById('register-section'),
            account: document.getElementById('account-section'),
            checkout: document.getElementById('checkout-section')
        };
        
        const showLoginBtn = document.getElementById('show-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showAccountBtn = document.getElementById('show-account-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const loginMessageEl = document.getElementById('login-message');
        const registerMessageEl = document.getElementById('register-message');
        const passwordMessageEl = document.getElementById('password-message');
        const accountNameEl = document.getElementById('account-name');
        const accountEmailEl = document.getElementById('account-email');
        const purchaseListEl = document.getElementById('purchase-list');
        const accountEmailCheckoutEl = document.getElementById('account-email-checkout');
        const submitLoginBtn = document.getElementById('submit-login-btn');
        const logoutBtn2 = document.getElementById('logout-btn-2'); // Botão na seção Conta

        // Variável global para o token reCAPTCHA
        window._lastRecaptchaToken = null; 
        
        // --- FUNÇÕES DE NAVEGAÇÃO E UTILS ---

        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            sections[sectionName].classList.add('active');

            if (sectionName === 'products') {
                swiperContainer.classList.add('active');
            } else {
                swiperContainer.classList.remove('active');
            }
        }
        
        function renderProducts() {
            productListEl.innerHTML = '';
            products.forEach(product => {
                const productCol = document.createElement('div');
                productCol.className = 'col'; 
                productCol.innerHTML = `
                    <div class="card h-100 rounded-4 shadow-sm product-card-custom">
                        <img src="images/${product.image}" class="card-img-top" alt="${product.name}">
                        <div class="card-body d-flex flex-column text-center">
                            <h3 class="card-title h5 fw-bold text-dark">${product.name}</h3>
                            <p class="card-text fs-5 text-success fw-bold">R$ ${product.price.toFixed(2)}</p>
                                <button class="btn btn-dark mt-auto shadow-sm btn-add-to-cart" data-add="${product.id}" onclick="addToCart(event, ${product.id})">
                                    <i class="bi bi-cart"></i> <span class="btn-add-text">Adicionar ao carrinho</span>
                                </button>
                        </div>
                    </div>
                `;
                productListEl.appendChild(productCol);
            });
        }
        
        function addToCart(e, productId) {
            let btnEl = null;
            try { btnEl = (e && e.target) ? e.target.closest('button') : null; } catch (err) { btnEl = null; }

            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }

            updateCart();

            if (btnEl) {
                const originalHtml = btnEl.innerHTML;
                btnEl.disabled = true;
                btnEl.classList.add('btn-added');
                btnEl.innerHTML = `<i class="bi bi-check2-circle"></i> <span class="btn-add-text">Adicionado</span>`;

                if (cartCountEl) {
                    cartCountEl.classList.add('cart-count-pulse');
                    setTimeout(() => cartCountEl.classList.remove('cart-count-pulse'), 600);
                }

                setTimeout(() => {
                    try {
                        btnEl.innerHTML = originalHtml;
                        btnEl.classList.remove('btn-added');
                        btnEl.disabled = false;
                    } catch (err) { /* ignore */ }
                }, 1400);
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<div class="alert alert-warning text-center m-3">Seu carrinho está vazio. Adicione alguns produtos!</div>';
                checkoutBtn.disabled = true;
            } else {
                checkoutBtn.disabled = false;
            }
            
            cart.forEach(item => {
                total += item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'list-group-item d-flex justify-content-between align-items-center p-3'; 
                cartItem.innerHTML = `
                    <div class="flex-grow-1">
                        <h4 class="mb-1 h6 fw-bold">${item.name}</h4>
                        <small class="text-muted">Quant: ${item.quantity}</small>
                        <p class="mb-0 fw-bold text-dark">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="removeFromCart(${item.id})">Remover</button>
                `;
                cartItemsEl.appendChild(cartItem);
            });
            
            cartTotalEl.textContent = total.toFixed(2);
            cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function updateNavButtons() {
            if (loggedInUser) {
                showLoginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
                showAccountBtn.style.display = 'inline';
            } else {
                showLoginBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
                showAccountBtn.style.display = 'none';
            }
        }

        function logout() {
            loggedInUser = null;
            sessionStorage.removeItem('loggedInUser'); 
            updateNavButtons();
            alert('Você saiu da sua conta.');
            showSection('products');
        }

        function jwt_decode(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        // reCAPTCHA: Habilita o botão de login após sucesso
        window.enableLoginButtons = function(token) {
            submitLoginBtn.disabled = false;
            window._lastRecaptchaToken = token;
            loginMessageEl.innerHTML = ''; 
        }

        // reCAPTCHA: Desabilita o botão
        function disableLoginButtons() {
            submitLoginBtn.disabled = true;
            window._lastRecaptchaToken = null;
        }

        // --- FUNÇÕES DE COMUNICAÇÃO COM O BACKEND (/api/users e /api/purchases) ---

        /**
         * Lida com o fluxo de Login Padrão e Google.
         */
        async function loginUser(email, password, isGoogleLogin = false, name = null) {
            let actionBody = { action: 'login', email };
            if (isGoogleLogin) {
                actionBody.name = name;
            } else {
                actionBody.password = password;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(actionBody)
                });

                const data = await response.json();
                if (data.success) {
                    // Guarda o estado do utilizador (incluindo se tem senha ou não)
                    loggedInUser = data.user; 
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    loginMessageEl.innerHTML = `<div class="success">Bem-vindo, ${loggedInUser.name}!</div>`;
                    updateNavButtons();
                    setTimeout(() => { showSection('products'); loginMessageEl.innerHTML = ''; }, 1500);
                } else {
                    loginMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
                }
            } catch (error) {
                loginMessageEl.innerHTML = `<div class="error">Erro de conexão com o servidor.</div>`;
                console.error('Erro no login:', error);
            }
        }

        /**
         * Lida com a resposta da API do Google Identity.
         */
        window.handleCredentialResponse = function(response) {
            if (!window._lastRecaptchaToken) {
                loginMessageEl.innerHTML = `<div class="error">Falha de segurança: reCAPTCHA não detectado. Por favor, resolva o reCAPTCHA antes de entrar com Google.</div>`;
                return;
            }

            // O token do reCAPTCHA não é usado no Google Login, mas a verificação é crucial
            window._lastRecaptchaToken = null; // Limpa após uso de qualquer forma

            const userObject = jwt_decode(response.credential);
            loginUser(userObject.email, null, true, userObject.name);
        }

        /**
         * Envia dados de registro para o backend (/api/users).
         */
        async function registerUser(name, email, password) {
            if (password.length < 6) { 
                registerMessageEl.innerHTML = `<div class="error">A senha deve ter pelo menos 6 caracteres.</div>`;
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'register', name, email, password })
                });

                const data = await response.json();
                if (data.success) {
                    registerMessageEl.innerHTML = `<div class="success">Cadastro realizado! Faça login para continuar.</div>`;
                    setTimeout(() => { showSection('login'); registerMessageEl.innerHTML = ''; }, 2000);
                } else {
                    registerMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
                }
            } catch (error) {
                registerMessageEl.innerHTML = `<div class="error">Erro de conexão com o servidor.</div>`;
                console.error('Erro no registro:', error);
            }
        }

        /**
         * Envia solicitação de alteração/definição de senha para o backend (/api/users).
         */
        async function changePassword(currentPassword, newPassword) {
            if (!loggedInUser) return;

            if (newPassword.length < 6) { 
                passwordMessageEl.innerHTML = `<div class="error">A nova senha deve ter pelo menos 6 caracteres.</div>`;
                return;
            }
            
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'change_password', 
                        email: loggedInUser.email, 
                        currentPassword, 
                        newPassword 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Atualiza o estado local do utilizador para refletir a mudança (sempre terá senha agora)
                    loggedInUser.password = true; 
                    sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                    
                    passwordMessageEl.innerHTML = `<div class="success">${data.message}</div>`;
                    
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    renderAccountPage(); 
                } else {
                    passwordMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
                }
            } catch (error) {
                passwordMessageEl.innerHTML = `<div class="error">Erro de conexão com o servidor.</div>`;
                console.error('Erro na alteração de senha:', error);
            }
        }

        /**
         * Salva a compra no backend (/api/purchases).
         * @returns {Promise<boolean>}
         */
        async function savePurchase() {
            if (!loggedInUser || cart.length === 0) return false;

            const purchaseData = {
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                items: cart
            };

            try {
                const response = await fetch('/api/purchases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userEmail: loggedInUser.email, purchaseData })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('Compra salva no DB (Neon). ID:', data.purchaseId);
                    return true;
                } else {
                    console.error('Erro ao salvar compra no DB:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('Erro de rede/servidor ao salvar compra:', error);
                return false;
            }
        }

        /**
         * Renderiza a página da conta, incluindo o histórico de compras do backend.
         */
        async function renderAccountPage() {
            if (!loggedInUser) return;
            accountNameEl.textContent = loggedInUser.name;
            accountEmailEl.textContent = loggedInUser.email;
            accountEmailCheckoutEl.textContent = loggedInUser.email; 

            // Lógica de Senha para Login Google (se nunca definiu senha)
            const currentPasswordContainer = document.getElementById('current-password-container');
            const currentPasswordField = document.getElementById('current-password');
            const newPasswordField = document.getElementById('new-password');

            if (loggedInUser.google && !loggedInUser.password) {
                if (currentPasswordContainer) {
                    currentPasswordContainer.style.display = 'none';
                    currentPasswordField.removeAttribute('required');
                }
                newPasswordField.placeholder = 'Defina sua Nova Senha';
                document.querySelector('#change-password-section h3').textContent = 'Definir Senha de Acesso';
                passwordMessageEl.innerHTML = `<div class="alert alert-info text-center m-0">Como é um login Google, defina uma senha para usar o acesso padrão.</div>`;
            } else {
                if (currentPasswordContainer) {
                    currentPasswordContainer.style.display = 'block';
                    currentPasswordField.setAttribute('required', 'required');
                }
                newPasswordField.placeholder = 'Nova Senha';
                document.querySelector('#change-password-section h3').textContent = 'Alterar Senha';
                passwordMessageEl.innerHTML = '';
            }
            
            // --- BUSCAR HISTÓRICO DE COMPRAS DO BACKEND ---
            purchaseListEl.innerHTML = '<div class="text-center p-3 text-muted">A carregar histórico...</div>';
            try {
                const response = await fetch(`/api/purchases?email=${loggedInUser.email}`);
                const data = await response.json();

                purchaseListEl.innerHTML = ''; // Limpa o "A carregar"

                if (data.success && data.purchases && data.purchases.length > 0) {
                    data.purchases.forEach(purchase => {
                        const purchaseEl = document.createElement('div');
                        purchaseEl.className = 'list-group-item list-group-item-action mb-3 rounded-3 shadow-sm';
                        // O campo 'items' vem do PG/JSONB
                        const itemsList = purchase.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                        purchaseEl.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1 text-primary">Pedido #${purchase.id}</h5>
                                <small class="text-muted">${purchase.date}</small>
                            </div>
                            <p class="mb-1 text-muted">Itens: ${itemsList}</p>
                            <p class="mb-0 fs-5 fw-bold text-success text-end">Total: R$ ${parseFloat(purchase.total).toFixed(2)}</p>
                        `;
                        purchaseListEl.appendChild(purchaseEl);
                    });
                } else {
                    purchaseListEl.innerHTML = '<div class="alert alert-info text-center">Nenhuma compra encontrada.</div>';
                }
            } catch (error) {
                console.error('Erro ao buscar histórico de compras:', error);
                purchaseListEl.innerHTML = '<div class="alert alert-danger text-center">Erro ao carregar o histórico.</div>';
            }
        }

        // --- FUNÇÃO PARA MONTAR O E-MAIL (Igual a que você já tinha) ---
        function buildEmailTemplate(user, cart) {
            const itemsTableBody = cart.map(item => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px 0; color: #333;">${item.name}</td>
                    <td style="padding: 10px 0; text-align: center; color: #333;">${item.quantity}</td>
                    <td style="padding: 10px 0; text-align: right; color: #333;">R$ ${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
            
            const fullMessageHtml = `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; background-color: #ffffff; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                    <div style="background-color: #1a1a1a; color: white; padding: 25px; text-align: center; border-bottom: 5px solid #28a745;">
                        <h1 style="margin: 0; font-size: 26px; font-weight: 600;">Minha Loja Online</h1>
                        <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.8;">Confirmação de Pedido Recebido</p>
                    </div>
                    <div style="padding: 30px;">
                        <h2 style="color: #1a1a1a; margin-top: 0; font-size: 20px;">Olá, <span style="color: #28a745; font-weight: 700;">${user.name}</span>!</h2>
                        <p style="font-size: 15px; margin-bottom: 25px;">Sua compra foi um sucesso! Recebemos o seu pedido e estamos processando os itens.</p>
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: #f9f9f9;">
                            <h3 style="color: #555; margin-top: 0; font-size: 16px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;">
                                Detalhes do Pedido
                            </h3>
                            <table width="100%" style="border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr style="background-color: #e0e0e0;">
                                        <th style="padding: 10px; text-align: left; color: #1a1a1a;">Produto</th>
                                        <th style="padding: 10px; text-align: center; color: #1a1a1a;">Qtd</th>
                                        <th style="padding: 10px; text-align: right; color: #1a1a1a;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsTableBody}
                                </tbody>
                            </table>
                            </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <p style="font-size: 18px; font-weight: 500; color: #1a1a1a; margin: 0;">TOTAL DA COMPRA:</p>
                            <p style="font-size: 30px; font-weight: bold; color: #28a745; margin: 5px 0 0 0;">R$ ${total}</p>
                        </div>
                        <p style="margin-top: 30px; font-size: 14px; color: #666; text-align: center;">
                            Você receberá um novo e-mail assim que o pedido for enviado.
                        </p>
                        <div style="margin-top: 20px; text-align: center; padding: 12px; background-color: #fff3cd; color: #856404; border-radius: 8px; font-weight: 700;">
                            (ATENÇÃO: Este é apenas um site de demonstração/brincadeira. Nenhuma compra é real)
                        </div>
                    </div>
                    <div style="background-color: #f4f4f4; color: #999; padding: 15px; text-align: center; font-size: 12px; border-top: 1px solid #eee;">
                        <p style="margin: 0;">Minha Loja Online | Onde a qualidade encontra você. <br>Em caso de dúvidas, entre em contato.</p>
                    </div>
                </div>
            `;
            
            return {
                to_name: user.name,
                to_email: user.email,
                message_html: fullMessageHtml,
                order_total: total
            };
        }


        // --- TRATADORES DE EVENTOS ---

        // Navegação
        document.getElementById('show-cart-btn').addEventListener('click', () => { updateCart(); showSection('cart'); });
        showLoginBtn.addEventListener('click', () => showSection('login'));
        showAccountBtn.addEventListener('click', () => {
            if (loggedInUser) {
                renderAccountPage();
                showSection('account');
            } else {
                alert('Você precisa estar logado para ver a sua conta!');
                showSection('login');
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', logout);
        logoutBtn2.addEventListener('click', logout); // Logout na seção conta
        
        showRegisterBtn.addEventListener('click', () => showSection('register'));
        
        // Form: Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target.querySelector('#login-email').value;
            const password = e.target.querySelector('#login-password').value;
            const recaptchaResponse = grecaptcha.getResponse();

            if (!recaptchaResponse) {
                loginMessageEl.innerHTML = `<div class="error">Por favor, resolva o "Não sou um robô".</div>`;
                return;
            }
            
            grecaptcha.reset(); // Limpa o reCAPTCHA
            disableLoginButtons(); // Bloqueia o botão

            loginUser(email, password, false);
        });

        // Form: Registro
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.querySelector('#register-name').value;
            const email = e.target.querySelector('#register-email').value;
            const password = e.target.querySelector('#register-password').value;

            registerUser(name, email, password);
        });

        // Form: Alterar Senha
        changePasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = e.target.querySelector('#current-password').value;
            const newPassword = e.target.querySelector('#new-password').value;
            changePassword(currentPassword, newPassword);
        });

        // Checkout
        checkoutBtn.addEventListener('click', async () => {
            if (cart.length === 0) {
                alert('Seu carrinho está vazio!');
                return;
            }

            if (!loggedInUser) {
                alert('Você precisa estar logado para finalizar a compra!');
                showSection('login');
                return;
            }

            // 1. Salvar a Compra no Neon/PostgreSQL
            const purchaseSaved = await savePurchase();
            
            if (!purchaseSaved) {
                alert('A compra não pôde ser salva no banco de dados. Tente novamente.');
                return;
            }

            // 2. Enviar o E-mail de Confirmação (Serverless Function)
            const emailData = buildEmailTemplate(loggedInUser, cart);
            const API_EMAIL_ENDPOINT = '/api/send-email'; 
            
            const payload = {
                to_email: emailData.to_email,
                to_name: emailData.to_name,
                subject: `Confirmação de Pedido - Total: R$ ${emailData.order_total}`,
                message_html: emailData.message_html, 
                order_total: emailData.order_total
            };

            try {
                const response = await fetch(API_EMAIL_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    // Lança erro, que será pego no bloco catch
                    throw new Error(`Erro no servidor de e-mail: Status ${response.status}`);
                }
                const data = await response.json();
                console.log('E-MAIL ENVIADO COM SUCESSO! Message ID:', data.messageId);

            } catch (error) {
                console.error('ERRO GERAL NO CHECKOUT (E-MAIL):', error);
                // Notifica o usuário, mas a compra já está salva no DB
                alert('A compra foi finalizada e salva, mas houve um erro ao enviar o e-mail de confirmação. Detalhes: ' + error.message); 
            }

            // 3. Finalizar a Transação no Frontend
            cart = [];
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCart();
            showSection('checkout');
        });

        // --- INICIALIZAÇÃO ---
        function initializeApp() {
            renderProducts();
            updateCart();
            updateNavButtons();
            
            // Inicialização do Swiper
            new Swiper(".mySwiper", {
                direction: "horizontal",
                loop: true,
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
            });

            // Garante o bloqueio inicial (até o reCAPTCHA ser resolvido)
            disableLoginButtons();
            
            // Garante que a seção de produtos é a inicial
            showSection('products'); 
        }

        initializeApp();
    </script>
</body>
</html>