<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - E-commerce Elegante</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        body {
            /* Fundo mais moderno com suave degrad√™ */
            background: linear-gradient(180deg, #f4f7fb 0%, #e9f2ff 100%);
            color: #1f2937;
        }
        /* Garantindo que apenas a se√ß√£o ativa apare√ßa */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Ajustes no Swiper */
        .swiper-container {
            display: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .swiper-container.active {
            display: block;
        }
        .swiper {
            width: 100%;
            height: 400px; /* Altura do Carrossel */
        }
        /* AJUSTE MAIS DETALHADO PARA O SWIPER */
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem cubra todo o slide sem distor√ß√£o */
        }
        
        /* Estiliza√ß√£o Avan√ßada para os Cards de Produto */
        .product-card-custom {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }
        .product-card-custom:hover {
            transform: translateY(-8px); /* Efeito de eleva√ß√£o */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important; /* Sombra mais destacada */
        }
        .product-card-custom .card-img-top {
            height: 220px;
            object-fit: cover;
        }

        /* Bot√£o 'Adicionar ao carrinho' estilizado e feedback */
        .btn-add-to-cart {
            background: linear-gradient(180deg,#0b7285 0%, #055a72 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .btn-add-to-cart:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(2,6,23,0.12); }
        .btn-add-to-cart:active { transform: translateY(0); }
        .btn-add-to-cart .bi { font-size: 1.05rem; }

        .btn-added {
            background: linear-gradient(180deg,#16a34a 0%, #15803d 100%) !important;
            color: #fff !important;
            box-shadow: 0 8px 18px rgba(16,185,129,0.18) !important;
        }

        /* Pulso no contador do carrinho */
        .cart-count-pulse {
            animation: cartPulse 520ms ease-in-out;
        }
        @keyframes cartPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.45); }
            100% { transform: scale(1); }
        }

        /* Ajuste para o √≠cone de senha - CORRE√á√ÉO 1 APLICADA AQUI */
        .password-container {
            position: relative;
        }
        .password-toggle-icon {
            /* Posi√ß√£o ajustada para alinhar no centro vertical do campo de input */
            position: absolute;
            right: 12px;
            top: 60%; /* Ajuste para melhor alinhamento com o input e a label */
            transform: translateY(-50%); 
            cursor: pointer;
            color: #aaa;
            z-index: 10;
        }

        /* Estilos de mensagens */
        .message {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .google-btn-container {
            /* Alterado: Adicionada flexbox para centralizar o bot√£o oficial do Google */
            padding-top: 10px;
        }
        /* Bot√£o Google customizado (usamos o render do Google dentro do cont√™iner) */
        /* Removido bot√£o customizado do Google para usar o bot√£o padr√£o renderizado pela biblioteca */
        
        /* --- CORRE√á√ïES DOS ESTILOS DA NAVBAR (APENAS COPIADO, SEM MUDAN√áAS) --- */
        
        /* Estilo Base: Garante que os bot√µes OUTLINE tenham texto claro na navbar escura */
        .navbar .btn-outline-primary,
        .navbar .btn-outline-light {
            border-color: #f0f2f5; /* Borda clara */
            color: #f0f2f5 !important; /* Cor do texto clara para contraste */
        }

        /* Base style para Sair */
        .navbar .btn-outline-danger {
            color: #f0f2f5 !important;
            border-color: #f0f2f5;
        }

        /* --- Ajuste do hover para ter as cores espec√≠ficas do Bootstrap --- */

        /* Login (Primary) Hover: Fica azul (cor prim√°ria) com texto branco */
        .navbar .btn-outline-primary:hover {
            background-color: #0d6efd; /* Cor azul primary do Bootstrap */
            color: white !important; 
            border-color: #0d6efd;
        }

        /* Minha Conta (Light) Hover: Fica claro com texto escuro */
        .navbar .btn-outline-light:hover {
            background-color: #f8f9fa; /* Cor clara light do Bootstrap */
            color: #1a1a1a !important; /* Texto escuro para contraste */
            border-color: #f8f9fa;
        }

        /* Sair (Danger) Hover: Fica vermelho (cor danger) com texto branco */
        .navbar .btn-outline-danger:hover {
            background-color: #dc3545; /* Cor vermelha danger do Bootstrap */
            color: white !important; 
            border-color: #dc3545;
        }
        
        /* Garante que o bot√£o de Sucesso (Carrinho) mant√©m o contraste */
        .navbar .btn-success {
            background-color: #28a745; 
            border-color: #28a745;
            color: white !important;
        }
        /* Nova paleta para a navbar: azul profundo com leve brilho */
        .navbar-custom {
            background: linear-gradient(90deg,#0f172a 0%, #0b4f6c 100%);
        }
        
        /* --- FIM DOS AJUSTES --- */
    </style>
</head>
<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-lg">
            <div class="container-fluid container-lg">
                <a class="navbar-brand fw-bold fs-4 text-white" href="#" onclick="showSection('products'); return false;">Minha Loja Online</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <button class="btn btn-success nav-link text-white mx-1 my-1 my-lg-0 position-relative" id="show-cart-btn">
                            <i class="bi bi-cart"></i> Carrinho 
                            <span class="badge bg-danger ms-1" id="cart-count">0</span>
                        </button>
                        
                        <button class="btn btn-outline-primary nav-link mx-1 my-1 my-lg-0" id="show-login-btn">Login</button>
                        <button class="btn btn-outline-light nav-link mx-1 my-1 my-lg-0" id="show-account-btn" style="display:none;">Minha Conta</button>
                        <button class="btn btn-outline-danger nav-link mx-1 my-1 my-lg-0" id="logout-btn" style="display:none;">Sair</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container my-5">
        
        <div class="swiper-container active mb-5">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide"><img src="images/livro.jpg" alt="Livro" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/canetas.jpg" alt="Canetas" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/relogio.jpg" alt="Rel√≥gio" class="img-fluid"></div>
                </div>
                <div class="swiper-pagination"></div>

                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>

        <div id="products-section" class="section active p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">‚ú® Destaques e Produtos</h2>
            <div id="product-list" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-5">
                </div>
        </div>

        <div id="cart-section" class="section p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">üõí Seu Carrinho</h2>
            <div id="cart-items" class="list-group list-group-flush border rounded-3">
                </div>
            <div id="cart-total-container" class="mt-4 p-3 border-top text-end bg-light rounded-bottom">
                <span class="fs-4 fw-bold text-dark">TOTAL: R$<span id="cart-total" class="text-success">0.00</span></span>
            </div>
            <button id="checkout-btn" class="btn btn-success btn-lg w-100 mt-3 shadow">Finalizar Compra</button>
        </div>

        <div id="login-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üîê Acesso √† Conta</h2>
            <form id="login-form" class="mx-auto">
                <div class="mb-3">
                    <label for="login-email" class="form-label">E-mail</label>
                    <input type="email" id="login-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="login-password" class="form-label">Senha</label>
                    <input type="password" id="login-password" class="form-control form-control-lg" placeholder="********" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('login-password')">üëÅÔ∏è</span>
                </div>
                <div class="mb-3 d-flex justify-content-center">
                    <div class="g-recaptcha" data-sitekey="6LcJrfArAAAAACRFhgeun6wDEA6AyEJ6IvCaX9SE"
                         data-callback="enableLoginButtons"
                         data-expired-callback="disableLoginButtons">
                    </div>
                </div>
                <button type="submit" id="submit-login-btn" class="btn btn-dark w-100 btn-lg shadow-sm" disabled>Entrar</button>
            </form>
            <div class="my-3 text-center text-muted">ou</div>
            
            <div class="google-btn-container d-flex justify-content-center" id="google-login-container">
                <div id="g_id_onload"
                    data-client_id="413829830677-b0q7j33043556os7iertf9b9ij9gbvbi.apps.googleusercontent.com"
                    data-callback="handleCredentialResponse"
                    data-ux_mode="popup"
                    data-auto_select="false"
                    data-context="signin">
                </div>
                
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="signin_with"
                     data-shape="pill"
                     data-logo_alignment="left">
                </div>
            </div>
            <p class="text-center mt-4 text-muted">Novo por aqui? <button id="show-register-btn" class="btn btn-link p-0 fw-bold align-baseline text-primary">Crie sua Conta</button></p>
            <div id="login-message" class="message"></div>
        </div>

        <div id="register-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üìù Cadastro R√°pido</h2>
            <form id="register-form" class="mx-auto">
                <div class="mb-3">
                    <label for="register-name" class="form-label">Nome Completo</label>
                    <input type="text" id="register-name" class="form-control form-control-lg" placeholder="Seu nome" required>
                </div>
                <div class="mb-3">
                    <label for="register-email" class="form-label">E-mail</label>
                    <input type="email" id="register-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="register-password" class="form-label">Senha</label>
                    <input type="password" id="register-password" class="form-control form-control-lg" placeholder="Crie uma senha forte" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('register-password')">üëÅÔ∏è</span>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">Cadastrar</button>
            </form>
            <div id="register-message" class="message"></div>
        </div>

        <div id="account-section" class="section p-4 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 800px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üë§ Minha Conta</h2>
            <div id="account-details" class="text-center mb-4 p-3 bg-light rounded-3">
                <h3 class="h5 fw-bold text-primary">Detalhes Pessoais</h3>
                <p class="mb-1 text-start"><strong>Nome:</strong> <span id="account-name"></span></p>
                <p class="mb-0 text-start"><strong>E-mail:</strong> <span id="account-email"></span></p>
            </div>
            <hr class="my-4">
            <div id="change-password-section" class="mt-4 p-3 border rounded-3 mx-auto" style="max-width: 400px;">
                <h3 class="h5 text-center mb-3">Alterar Senha</h3>
                <form id="change-password-form">
                    <div class="mb-3 password-container" id="current-password-container"> 
                        <input type="password" id="current-password" class="form-control" placeholder="Senha Atual" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('current-password')">üëÅÔ∏è</span>
                    </div>
                    <div class="mb-3 password-container">
                        <input type="password" id="new-password" class="form-control" placeholder="Nova Senha" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('new-password')">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="btn btn-outline-dark w-100">Alterar Senha</button>
                </form>
                <div id="password-message" class="message"></div>
            </div>
            <hr class="my-4">
            <div id="purchase-history" class="mt-4">
                <h3 class="h5 text-center mb-3">üßæ Hist√≥rico de Compras</h3>
                <div id="purchase-list" class="list-group"></div>
            </div>
        </div>

        <div id="checkout-section" class="section bg-light text-center">
            <div class="d-flex flex-column justify-content-center align-items-center min-vh-100 pt-5 pb-5"> 
                <div class="p-5 bg-success text-white rounded-4 shadow-lg" style="max-width: 800px; width: 90%;">
                    <h2 class="h1 fw-bold">Compra Finalizada üéâ</h2>
                    <p class="lead mt-3">Obrigado por sua compra! Seu pedido foi processado com sucesso.</p>
                    <p class="mt-4">Um e-mail de confirma√ß√£o ser√° enviado para <span id="account-email-checkout" class="fw-bold">seu e-mail</span>.</p>
                    <p class="mt-3 text-warning fw-bold">(ATEN√á√ÉO: Este √© apenas um site de demonstra√ß√£o/brincadeira. Nenhum produto ser√° enviado e nenhuma compra √© real)</p>
                </div>
            </div>
        </div>
        </div>
    
    <footer class="bg-dark text-white-50 mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Minha Loja Online. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
    // LISTA DE PRODUTOS
    const products = [
        { id: 1, name: 'Notebook Pro', price: 2500.00, image: 'notebook.jpg' },
        { id: 2, name: 'Fone de Ouvido sem Fio', price: 350.50, image: 'fone.jpg' },
        { id: 3, name: 'Rel√≥gio Inteligente', price: 800.00, image: 'relogio.jpg' },
        { id: 4, name: 'Kit de Canetas', price: 45.90, image: 'canetas.jpg' },
        { id: 5, name: 'Planta Decorativa', price: 120.00, image: 'planta.jpg' },
        { id: 6, name: 'Livro', price: 75.00, image: 'livro.jpg' },
    ];
    
    // ESTADO: O carrinho continua no localStorage para persist√™ncia.
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    // ESTADO: O usu√°rio logado agora usa sessionStorage (mais seguro para sess√µes).
    let loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
    
    // API ENDPOINTS (Devemos ter estes arquivos na pasta /api)
    const API_USER_ENDPOINT = '/api/users';
    const API_PURCHASE_ENDPOINT = '/api/purchases';
    const API_EMAIL_ENDPOINT = '/api/send-email';
    
    // Refer√™ncias DOM (mantidas do seu c√≥digo original)
    const productListEl = document.getElementById('product-list');
    const cartItemsEl = document.getElementById('cart-items');
    const cartTotalEl = document.getElementById('cart-total');
    const cartCountEl = document.getElementById('cart-count');
    const swiperContainer = document.querySelector('.swiper-container');
    
    const sections = {
        products: document.getElementById('products-section'),
        cart: document.getElementById('cart-section'),
        login: document.getElementById('login-section'),
        register: document.getElementById('register-section'),
        account: document.getElementById('account-section'),
        checkout: document.getElementById('checkout-section')
    };
    
    const showCartBtn = document.getElementById('show-cart-btn');
    const showLoginBtn = document.getElementById('show-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const showRegisterBtn = document.getElementById('show-register-btn');
    const showAccountBtn = document.getElementById('show-account-btn');
    const checkoutBtn = document.getElementById('checkout-btn');
    
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const changePasswordForm = document.getElementById('change-password-form');
    const loginMessageEl = document.getElementById('login-message');
    const registerMessageEl = document.getElementById('register-message');
    const passwordMessageEl = document.getElementById('password-message');
    const accountNameEl = document.getElementById('account-name');
    const accountEmailEl = document.getElementById('account-email');
    const purchaseListEl = document.getElementById('purchase-list');
    const accountEmailCheckoutEl = document.getElementById('account-email-checkout');

    const submitLoginBtn = document.getElementById('submit-login-btn');
    const googleLoginContainer = document.getElementById('google-login-container');
    
    // Vari√°vel global para o token reCAPTCHA
    window._lastRecaptchaToken = null; 

    // --- FUN√á√ïES DE NAVEGA√á√ÉO E UX (MANTIDAS) ---

    function showSection(sectionName) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        sections[sectionName].classList.add('active');

        if (sectionName === 'products') {
            swiperContainer.classList.add('active');
        } else {
            swiperContainer.classList.remove('active');
        }
    }
    
    function renderProducts() {
        // ... (Corpo da fun√ß√£o renderProducts mantido) ...
        productListEl.innerHTML = '';
        products.forEach(product => {
            const productCol = document.createElement('div');
            productCol.className = 'col'; 
            productCol.innerHTML = `
                <div class="card h-100 rounded-4 shadow-sm product-card-custom">
                    <img src="images/${product.image}" class="card-img-top" alt="${product.name}">
                    <div class="card-body d-flex flex-column text-center">
                        <h3 class="card-title h5 fw-bold text-dark">${product.name}</h3>
                        <p class="card-text fs-5 text-success fw-bold">R$ ${product.price.toFixed(2)}</p>
                            <button class="btn btn-dark mt-auto shadow-sm btn-add-to-cart" data-add="${product.id}" onclick="addToCart(event, ${product.id})">
                                <i class="bi bi-cart"></i> <span class="btn-add-text">Adicionar ao carrinho</span>
                            </button>
                    </div>
                </div>
            `;
            productListEl.appendChild(productCol);
        });
    }
    
    function addToCart(e, productId) {
        let btnEl = null;
        try { btnEl = (e && e.target) ? e.target.closest('button') : null; } catch (err) { btnEl = null; }

        const product = products.find(p => p.id === productId);
        const existingItem = cart.find(item => item.id === productId);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({ ...product, quantity: 1 });
        }

        updateCart();

        if (btnEl) {
            const originalHtml = btnEl.innerHTML;
            btnEl.disabled = true;
            btnEl.classList.add('btn-added');
            btnEl.innerHTML = `<i class="bi bi-check2-circle"></i> <span class="btn-add-text">Adicionado</span>`;

            if (cartCountEl) {
                cartCountEl.classList.add('cart-count-pulse');
                setTimeout(() => cartCountEl.classList.remove('cart-count-pulse'), 600);
            }

            setTimeout(() => {
                try {
                    btnEl.innerHTML = originalHtml;
                    btnEl.classList.remove('btn-added');
                    btnEl.disabled = false;
                } catch (err) { /* ignore */ }
            }, 1400);
        }
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCart();
    }

    function updateCart() {
        cartItemsEl.innerHTML = '';
        let total = 0;
        
        if (cart.length === 0) {
            cartItemsEl.innerHTML = '<div class="alert alert-warning text-center m-3">Seu carrinho est√° vazio. Adicione alguns produtos!</div>';
            checkoutBtn.disabled = true;
        } else {
            checkoutBtn.disabled = false;
        }
        
        cart.forEach(item => {
            total += item.price * item.quantity;
            const cartItem = document.createElement('div');
            cartItem.className = 'list-group-item d-flex justify-content-between align-items-center p-3'; 
            cartItem.innerHTML = `
                <div class="flex-grow-1">
                    <h4 class="mb-1 h6 fw-bold">${item.name}</h4>
                    <small class="text-muted">Quant: ${item.quantity}</small>
                    <p class="mb-0 fw-bold text-dark">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                </div>
                <button class="btn btn-sm btn-outline-danger ms-3" onclick="removeFromCart(${item.id})">Remover</button>
            `;
            cartItemsEl.appendChild(cartItem);
        });
        
        cartTotalEl.textContent = total.toFixed(2);
        cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    function updateNavButtons() {
        if (loggedInUser) {
            showLoginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline';
            showAccountBtn.style.display = 'inline';
        } else {
            showLoginBtn.style.display = 'inline';
            logoutBtn.style.display = 'none';
            showAccountBtn.style.display = 'none';
        }
    }

    function logout() {
        loggedInUser = null;
        sessionStorage.removeItem('loggedInUser'); 
        updateNavButtons();
        alert('Voc√™ saiu da sua conta.');
        showSection('products');
    }

    function togglePasswordVisibility(fieldId) {
        const passwordField = document.getElementById(fieldId);
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
    }
    
    function jwt_decode(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }
    
    // reCAPTCHA: Habilita o bot√£o de login ap√≥s sucesso
    window.enableLoginButtons = function(token) {
        submitLoginBtn.disabled = false;
        window._lastRecaptchaToken = token;
        loginMessageEl.innerHTML = ''; 
    }

    // reCAPTCHA: Desabilita o bot√£o
    function disableLoginButtons() {
        submitLoginBtn.disabled = true;
        window._lastRecaptchaToken = null;
    }

    // --- FUN√á√ïES DE COMUNICA√á√ÉO COM O BACKEND (MIGRA√á√ÉO DE ARMAZENAMENTO) ---
    
    /**
     * Lida com o fluxo de Login Padr√£o e Google (via API).
     */
    async function loginUser(email, password, isGoogleLogin = false, name = null) {
        let actionBody = { action: 'login', email };
        if (isGoogleLogin) {
            // O login Google n√£o envia senha, o backend busca a conta pelo email
            actionBody.name = name;
            actionBody.recaptcha = window._lastRecaptchaToken;
        } else {
            // Login com senha
            actionBody.password = password;
            actionBody.recaptcha = window._lastRecaptchaToken;
        }
        
        try {
            const response = await fetch(API_USER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(actionBody)
            });

            const data = await response.json();
            
            if (data.success) {
                loggedInUser = data.user; 
                sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                loginMessageEl.innerHTML = `<div class="success">Bem-vindo, ${loggedInUser.name}!</div>`;
                updateNavButtons();
                setTimeout(() => { showSection('products'); loginMessageEl.innerHTML = ''; }, 1500);
            } else {
                loginMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
            }
        } catch (error) {
            loginMessageEl.innerHTML = `<div class="error">Erro de conex√£o com o servidor.</div>`;
            console.error('Erro no login:', error);
        }
        // Independentemente do resultado, limpa e reseta o reCAPTCHA para o pr√≥ximo uso
        if (window.grecaptcha) {
            window.grecaptcha.reset(); 
            disableLoginButtons();
        }
    }

    /**
     * Lida com a resposta da API do Google Identity (via API).
     */
    window.handleCredentialResponse = function(response) {
        if (!window._lastRecaptchaToken) {
            loginMessageEl.innerHTML = `<div class="error">Falha de seguran√ßa: reCAPTCHA n√£o detectado. Por favor, resolva o reCAPTCHA antes de entrar com Google.</div>`;
            return;
        }

        const userObject = jwt_decode(response.credential);
        // O reCAPTCHA ser√° verificado dentro da fun√ß√£o loginUser com o token em window._lastRecaptchaToken
        loginUser(userObject.email, null, true, userObject.name);
    }

    /**
     * Envia dados de registro para o backend (via API).
     */
    async function registerUser(name, email, password) {
        if (password.length < 6) { 
            registerMessageEl.innerHTML = `<div class="error">A senha deve ter pelo menos 6 caracteres.</div>`;
            return;
        }

        try {
            const response = await fetch(API_USER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'register', name, email, password })
            });

            const data = await response.json();
            if (data.success) {
                registerMessageEl.innerHTML = `<div class="success">Cadastro realizado! Fa√ßa login para continuar.</div>`;
                setTimeout(() => { showSection('login'); registerMessageEl.innerHTML = ''; }, 2000);
            } else {
                registerMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
            }
        } catch (error) {
            registerMessageEl.innerHTML = `<div class="error">Erro de conex√£o com o servidor.</div>`;
            console.error('Erro no registro:', error);
        }
    }

    /**
     * Envia solicita√ß√£o de altera√ß√£o/defini√ß√£o de senha (via API).
     */
    async function changePassword(currentPassword, newPassword) {
        if (!loggedInUser) return;

        if (newPassword.length < 6) { 
            passwordMessageEl.innerHTML = `<div class="error">A nova senha deve ter pelo menos 6 caracteres.</div>`;
            return;
        }

        // L√≥gica de Senha para Login Google (se nunca definiu senha)
        const isGoogleUserWithoutPassword = loggedInUser.google && loggedInUser.password === null;
        
        let actionBody = { 
            action: 'change_password', 
            email: loggedInUser.email, 
            newPassword 
        };

        if (!isGoogleUserWithoutPassword) {
            // Se o usu√°rio tem senha (ou √© login padr√£o), a senha atual √© obrigat√≥ria
            if (!currentPassword) {
                 passwordMessageEl.innerHTML = `<div class="error">A senha atual √© obrigat√≥ria para altera√ß√£o.</div>`;
                 return;
            }
            actionBody.currentPassword = currentPassword;
        }
        
        try {
            const response = await fetch(API_USER_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(actionBody)
            });

            const data = await response.json();

            if (data.success) {
                // Atualiza o estado local do utilizador para refletir a mudan√ßa
                loggedInUser.password = true; // Se mudou, ele passa a ter uma senha (para o frontend)
                sessionStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                
                passwordMessageEl.innerHTML = `<div class="success">${data.message}</div>`;
                
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                renderAccountPage(); 
            } else {
                passwordMessageEl.innerHTML = `<div class="error">${data.message}</div>`;
            }
        } catch (error) {
            passwordMessageEl.innerHTML = `<div class="error">Erro de conex√£o com o servidor.</div>`;
            console.error('Erro na altera√ß√£o de senha:', error);
        }
    }

    /**
     * Salva a compra no backend (via API).
     * @returns {Promise<boolean>}
     */
    async function savePurchase() {
        if (!loggedInUser || cart.length === 0) return false;

        const purchaseData = {
            total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
            items: cart
        };

        try {
            const response = await fetch(API_PURCHASE_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail: loggedInUser.email, purchaseData })
            });

            const data = await response.json();
            if (data.success) {
                console.log('Compra salva no DB (Neon). ID:', data.purchaseId);
                return true;
            } else {
                console.error('Erro ao salvar compra no DB:', data.message);
                return false;
            }
        } catch (error) {
            console.error('Erro de rede/servidor ao salvar compra:', error);
            return false;
        }
    }

    /**
     * Renderiza a p√°gina da conta, incluindo o hist√≥rico de compras do backend (via API).
     */
    async function renderAccountPage() {
        if (!loggedInUser) return;
        accountNameEl.textContent = loggedInUser.name;
        accountEmailEl.textContent = loggedInUser.email;
        accountEmailCheckoutEl.textContent = loggedInUser.email; 

        // L√≥gica de Senha para Login Google (se nunca definiu senha)
        const currentPasswordContainer = document.getElementById('current-password-container');
        const currentPasswordField = document.getElementById('current-password');
        const newPasswordField = document.getElementById('new-password');

        // Note: loggedInUser.password √© boolean/string/null no backend, mas usamos o null para identificar o Google
        if (loggedInUser.google && loggedInUser.password === null) {
            if (currentPasswordContainer) {
                currentPasswordContainer.style.display = 'none';
                currentPasswordField.removeAttribute('required');
            }
            newPasswordField.placeholder = 'Defina sua Nova Senha';
            document.querySelector('#change-password-section h3').textContent = 'Definir Senha de Acesso';
            passwordMessageEl.innerHTML = `<div class="alert alert-info text-center m-0">Como √© um login Google, defina uma senha para usar o acesso padr√£o.</div>`;
        } else {
            if (currentPasswordContainer) {
                currentPasswordContainer.style.display = 'block';
                currentPasswordField.setAttribute('required', 'required');
            }
            newPasswordField.placeholder = 'Nova Senha';
            document.querySelector('#change-password-section h3').textContent = 'Alterar Senha';
            passwordMessageEl.innerHTML = '';
        }
        
        // --- BUSCAR HIST√ìRICO DE COMPRAS DO BACKEND ---
        purchaseListEl.innerHTML = '<div class="text-center p-3 text-muted">A carregar hist√≥rico...</div>';
        try {
            const response = await fetch(`${API_PURCHASE_ENDPOINT}?email=${loggedInUser.email}`);
            const data = await response.json();

            purchaseListEl.innerHTML = ''; // Limpa o "A carregar"

            if (data.success && data.purchases && data.purchases.length > 0) {
                data.purchases.forEach(purchase => {
                    const purchaseEl = document.createElement('div');
                    purchaseEl.className = 'list-group-item list-group-item-action mb-3 rounded-3 shadow-sm';
                    // O campo 'items' vem do PG/JSONB
                    const itemsList = purchase.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    
                    // Converte a data (se vier em formato ISO do PG) para local
                    const purchaseDate = new Date(purchase.date).toLocaleString();

                    purchaseEl.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 text-primary">Pedido #${purchase.id}</h5>
                            <small class="text-muted">${purchaseDate}</small>
                        </div>
                        <p class="mb-1 text-muted">Itens: ${itemsList}</p>
                        <p class="mb-0 fs-5 fw-bold text-success text-end">Total: R$ ${parseFloat(purchase.total).toFixed(2)}</p>
                    `;
                    purchaseListEl.appendChild(purchaseEl);
                });
            } else {
                purchaseListEl.innerHTML = '<div class="alert alert-info text-center">Nenhuma compra encontrada.</div>';
            }
        } catch (error) {
            console.error('Erro ao buscar hist√≥rico de compras:', error);
            purchaseListEl.innerHTML = '<div class="alert alert-danger text-center">Erro ao carregar o hist√≥rico.</div>';
        }
    }
    
    // --- FUN√á√ÉO PARA MONTAR O E-MAIL (MANTIDA) ---
    function buildEmailTemplate(user, cart) {
        // ... (Corpo da fun√ß√£o buildEmailTemplate mantido e funcional) ...
        const itemsTableBody = cart.map(item => `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px 0; color: #333;">${item.name}</td>
                <td style="padding: 10px 0; text-align: center; color: #333;">${item.quantity}</td>
                <td style="padding: 10px 0; text-align: right; color: #333;">R$ ${(item.price * item.quantity).toFixed(2)}</td>
            </tr>
        `).join('');

        const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toFixed(2);
        
        const fullMessageHtml = `
            <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; background-color: #ffffff; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                
                <div style="background-color: #1a1a1a; color: white; padding: 25px; text-align: center; border-bottom: 5px solid #28a745;">
                    <h1 style="margin: 0; font-size: 26px; font-weight: 600;">Minha Loja Online</h1>
                    <p style="margin: 5px 0 0; font-size: 14px; opacity: 0.8;">Confirma√ß√£o de Pedido Recebido</p>
                </div>

                <div style="padding: 30px;">
                    
                    <h2 style="color: #1a1a1a; margin-top: 0; font-size: 20px;">Ol√°, <span style="color: #28a745; font-weight: 700;">${user.name}</span>!</h2>
                    
                    <p style="font-size: 15px; margin-bottom: 25px;">Sua compra foi um sucesso! Recebemos o seu pedido e estamos processando os itens.</p>

                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: #f9f9f9;">
                        <h3 style="color: #555; margin-top: 0; font-size: 16px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px;">
                            Detalhes do Pedido
                        </h3>
                        
                        <table width="100%" style="border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background-color: #e0e0e0;">
                                    <th style="padding: 10px; text-align: left; color: #1a1a1a;">Produto</th>
                                    <th style="padding: 10px; text-align: center; color: #1a1a1a;">Qtd</th>
                                    <th style="padding: 10px; text-align: right; color: #1a1a1a;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsTableBody}
                            </tbody>
                        </table>
                        </div>
                    
                    <div style="margin-top: 30px; text-align: right;">
                        <p style="font-size: 18px; font-weight: 500; color: #1a1a1a; margin: 0;">TOTAL DA COMPRA:</p>
                        <p style="font-size: 30px; font-weight: bold; color: #28a745; margin: 5px 0 0 0;">R$ ${total}</p>
                    </div>
                    
                    <p style="margin-top: 30px; font-size: 14px; color: #666; text-align: center;">
                        Voc√™ receber√° um novo e-mail assim que o pedido for enviado.
                    </p>
                    
                    <div style="margin-top: 20px; text-align: center; padding: 12px; background-color: #fff3cd; color: #856404; border-radius: 8px; font-weight: 700;">
                        (ATEN√á√ÉO: Este √© apenas um site de demonstra√ß√£o/brincadeira. Nenhum produto ser√° enviado e nenhuma compra √© real)
                    </div>
                </div>

                <div style="background-color: #f4f4f4; color: #999; padding: 15px; text-align: center; font-size: 12px; border-top: 1px solid #eee;">
                    <p style="margin: 0;">Minha Loja Online | Onde a qualidade encontra voc√™. <br>Em caso de d√∫vidas, entre em contato.</p>
                </div>
            </div>
        `;
        
        return {
            to_name: user.name,
            to_email: user.email,
            message_html: fullMessageHtml,
            from_name: "Minha Loja Online",
            order_total: total
        };
    }
    
    // Event Listeners (Tratadores de Eventos)
    showCartBtn.addEventListener('click', () => { updateCart(); showSection('cart'); });
    showLoginBtn.addEventListener('click', () => showSection('login'));
    showAccountBtn.addEventListener('click', () => {
        if (loggedInUser) {
            renderAccountPage();
            showSection('account');
        } else {
            alert('Voc√™ precisa estar logado para ver a sua conta!');
            showSection('login');
        }
    });
    logoutBtn.addEventListener('click', logout);
    showRegisterBtn.addEventListener('click', () => showSection('register'));
    
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = e.target.querySelector('#login-email').value;
        const password = e.target.querySelector('#login-password').value;
        const recaptchaResponse = grecaptcha.getResponse();

        if (!recaptchaResponse) {
            loginMessageEl.innerHTML = `<div class="error">Por favor, resolva o "N√£o sou um rob√¥".</div>`;
            return;
        }
        
        // O reset e disable s√£o tratados dentro de loginUser
        loginUser(email, password, false);
    });

    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = e.target.querySelector('#register-name').value;
        const email = e.target.querySelector('#register-email').value;
        const password = e.target.querySelector('#register-password').value;

        registerUser(name, email, password);
    });

    changePasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const currentPassword = e.target.querySelector('#current-password').value;
        const newPassword = e.target.querySelector('#new-password').value;
        changePassword(currentPassword, newPassword);
    });

    // CHECKOUT: SALVAR NO DB E ENVIAR E-MAIL
    checkoutBtn.addEventListener('click', async () => {
        if (cart.length === 0) {
            alert('Seu carrinho est√° vazio!');
            return;
        }

        if (!loggedInUser) {
            alert('Voc√™ precisa estar logado para finalizar a compra!');
            showSection('login');
            return;
        }

        // 1. Salvar a Compra no Neon/PostgreSQL
        const purchaseSaved = await savePurchase();
        
        if (!purchaseSaved) {
            alert('A compra n√£o p√¥de ser salva no banco de dados. Tente novamente.');
            return;
        }

        // 2. Enviar o E-mail de Confirma√ß√£o (Serverless Function)
        const emailData = buildEmailTemplate(loggedInUser, cart);
        
        const payload = {
            to_email: emailData.to_email,
            to_name: emailData.to_name,
            subject: `Confirma√ß√£o de Pedido - Total: R$ ${emailData.order_total}`,
            message_html: emailData.message_html, 
            order_total: emailData.order_total
        };

        try {
            const response = await fetch(API_EMAIL_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                // Lan√ßa erro, que ser√° pego no bloco catch
                throw new Error(`Erro no servidor de e-mail: Status ${response.status}`);
            }
            const data = await response.json();
            console.log('E-MAIL ENVIADO COM SUCESSO! Message ID:', data.messageId);

        } catch (error) {
            console.error('ERRO GERAL NO CHECKOUT (E-MAIL):', error);
            // Notifica o usu√°rio, mas a compra j√° est√° salva no DB
            alert('A compra foi finalizada e salva, mas houve um erro ao enviar o e-mail de confirma√ß√£o. Detalhes: ' + error.message); 
        }

        // 3. Finalizar a Transa√ß√£o no Frontend
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCart();
        showSection('checkout');
    });

    // Inicializa√ß√£o
    function initializeApp() {
        renderProducts();
        updateCart();
        updateNavButtons();
        
        // Inicializa√ß√£o do Swiper
        new Swiper(".mySwiper", {
            direction: "horizontal",
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            pagination: {
                el: ".swiper-pagination",
                clickable: true,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });

        // GARANTINDO O BLOQUEIO INICIAL DOS BOT√ïES DE LOGIN
        disableLoginButtons();
        
        // Garante que a se√ß√£o de produtos √© a inicial
        showSection('products'); 
    }

    initializeApp();
     </script>
</body>
</html>