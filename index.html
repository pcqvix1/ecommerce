<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - E-commerce Elegante</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        body {
            background-color: #f0f2f5; /* Um cinza claro suave */
        }
        /* Garantindo que apenas a se√ß√£o ativa apare√ßa */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Ajustes no Swiper */
        .swiper-container {
            display: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .swiper-container.active {
            display: block;
        }
        .swiper {
            width: 100%;
            height: 400px; /* Altura do Carrossel */
        }
        /* AJUSTE MAIS DETALHADO PARA O SWIPER */
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem cubra todo o slide sem distor√ß√£o */
        }
        
        /* Estiliza√ß√£o Avan√ßada para os Cards de Produto */
        .product-card-custom {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }
        .product-card-custom:hover {
            transform: translateY(-8px); /* Efeito de eleva√ß√£o */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important; /* Sombra mais destacada */
        }
        .product-card-custom .card-img-top {
            height: 220px;
            object-fit: cover;
        }

        /* Ajuste para o √≠cone de senha - CORRE√á√ÉO 1 APLICADA AQUI */
        .password-container {
            position: relative;
        }
        .password-toggle-icon {
            /* Posi√ß√£o ajustada para alinhar no centro vertical do campo de input */
            position: absolute;
            right: 12px;
            top: 60%; /* Ajuste para melhor alinhamento com o input e a label */
            transform: translateY(-50%); 
            cursor: pointer;
            color: #aaa;
            z-index: 10;
        }

        /* Estilos de mensagens */
        .message {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .google-btn-container {
            max-width: 250px;
            margin: 0 auto;
            padding-top: 10px;
        }
        
        /* --- CORRE√á√ïES DOS ESTILOS DA NAVBAR (APENAS COPIADO, SEM MUDAN√áAS) --- */
        
        /* Estilo Base: Garante que os bot√µes OUTLINE tenham texto claro na navbar escura */
        .navbar .btn-outline-primary,
        .navbar .btn-outline-light {
            border-color: #f0f2f5; /* Borda clara */
            color: #f0f2f5 !important; /* Cor do texto clara para contraste */
        }

        /* Base style para Sair */
        .navbar .btn-outline-danger {
            color: #f0f2f5 !important;
            border-color: #f0f2f5;
        }

        /* --- Ajuste do hover para ter as cores espec√≠ficas do Bootstrap --- */

        /* Login (Primary) Hover: Fica azul (cor prim√°ria) com texto branco */
        .navbar .btn-outline-primary:hover {
            background-color: #0d6efd; /* Cor azul primary do Bootstrap */
            color: white !important; 
            border-color: #0d6efd;
        }

        /* Minha Conta (Light) Hover: Fica claro com texto escuro */
        .navbar .btn-outline-light:hover {
            background-color: #f8f9fa; /* Cor clara light do Bootstrap */
            color: #1a1a1a !important; /* Texto escuro para contraste */
            border-color: #f8f9fa;
        }

        /* Sair (Danger) Hover: Fica vermelho (cor danger) com texto branco */
        .navbar .btn-outline-danger:hover {
            background-color: #dc3545; /* Cor vermelha danger do Bootstrap */
            color: white !important; 
            border-color: #dc3545;
        }
        
        /* Garante que o bot√£o de Sucesso (Carrinho) mant√©m o contraste */
        .navbar .btn-success {
            background-color: #28a745; 
            border-color: #28a745;
            color: white !important;
        }
        
        /* --- FIM DOS AJUSTES --- */
    </style>
</head>
<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-lg">
            <div class="container-fluid container-lg">
                <a class="navbar-brand fw-bold fs-4 text-white" href="#" onclick="showSection('products'); return false;">Minha Loja Online</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <button class="btn btn-success nav-link text-white mx-1 my-1 my-lg-0 position-relative" id="show-cart-btn">
                            <i class="bi bi-cart"></i> Carrinho 
                            <span class="badge bg-danger ms-1" id="cart-count">0</span>
                        </button>
                        
                        <button class="btn btn-outline-primary nav-link mx-1 my-1 my-lg-0" id="show-login-btn">Login</button>
                        <button class="btn btn-outline-light nav-link mx-1 my-1 my-lg-0" id="show-account-btn" style="display:none;">Minha Conta</button>
                        <button class="btn btn-outline-danger nav-link mx-1 my-1 my-lg-0" id="logout-btn" style="display:none;">Sair</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container my-5">
        
        <div class="swiper-container active mb-5">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide"><img src="images/livro.jpg" alt="Livro" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/canetas.jpg" alt="Canetas" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/relogio.jpg" alt="Rel√≥gio" class="img-fluid"></div>
                </div>
                <div class="swiper-pagination"></div>

                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>

        <div id="products-section" class="section active p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">‚ú® Destaques e Produtos</h2>
            <div id="product-list" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-5">
                </div>
        </div>

        <div id="cart-section" class="section p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">üõí Seu Carrinho</h2>
            <div id="cart-items" class="list-group list-group-flush border rounded-3">
                </div>
            <div id="cart-total-container" class="mt-4 p-3 border-top text-end bg-light rounded-bottom">
                <span class="fs-4 fw-bold text-dark">TOTAL: R$<span id="cart-total" class="text-success">0.00</span></span>
            </div>
            <button id="checkout-btn" class="btn btn-success btn-lg w-100 mt-3 shadow">Finalizar Compra</button>
        </div>

        <div id="login-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üîê Acesso √† Conta</h2>
            <form id="login-form" class="mx-auto">
                <div class="mb-3">
                    <label for="login-email" class="form-label">E-mail</label>
                    <input type="email" id="login-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="login-password" class="form-label">Senha</label>
                    <input type="password" id="login-password" class="form-control form-control-lg" placeholder="********" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('login-password')">üëÅÔ∏è</span>
                </div>
                <div class="mb-3 d-flex justify-content-center">
                    <div class="g-recaptcha" data-sitekey="6LcJrfArAAAAACRFhgeun6wDEA6AyEJ6IvCaX9SE"
                         data-callback="enableLoginButtons"
                         data-expired-callback="disableLoginButtons">
                    </div>
                </div>
                <button type="submit" id="submit-login-btn" class="btn btn-dark w-100 btn-lg shadow-sm" disabled>Entrar</button>
            </form>
            <div class="my-3 text-center text-muted">ou</div>
            
            <div class="google-btn-container" id="google-login-container" style="pointer-events: none; opacity: 0.6;">
                <div id="g_id_onload"
                    data-client_id="413829830677-q5inimb5f2pj7iu95mkege78hrkt80vo.apps.googleusercontent.com"
                    data-callback="handleCredentialResponse">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-width="250"></div>
            </div>
            
            <p class="text-center mt-4 text-muted">Novo por aqui? <button id="show-register-btn" class="btn btn-link p-0 fw-bold align-baseline text-primary">Crie sua Conta</button></p>
            <div id="login-message" class="message"></div>
        </div>

        <div id="register-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üìù Cadastro R√°pido</h2>
            <form id="register-form" class="mx-auto">
                <div class="mb-3">
                    <label for="register-name" class="form-label">Nome Completo</label>
                    <input type="text" id="register-name" class="form-control form-control-lg" placeholder="Seu nome" required>
                </div>
                <div class="mb-3">
                    <label for="register-email" class="form-label">E-mail</label>
                    <input type="email" id="register-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="register-password" class="form-label">Senha</label>
                    <input type="password" id="register-password" class="form-control form-control-lg" placeholder="Crie uma senha forte" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('register-password')">üëÅÔ∏è</span>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">Cadastrar</button>
            </form>
            <div id="register-message" class="message"></div>
        </div>

        <div id="account-section" class="section p-4 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 800px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üë§ Minha Conta</h2>
            <div id="account-details" class="text-center mb-4 p-3 bg-light rounded-3">
                <h3 class="h5 fw-bold text-primary">Detalhes Pessoais</h3>
                <p class="mb-1 text-start"><strong>Nome:</strong> <span id="account-name"></span></p>
                <p class="mb-0 text-start"><strong>E-mail:</strong> <span id="account-email"></span></p>
            </div>
            <hr class="my-4">
            <div id="change-password-section" class="mt-4 p-3 border rounded-3 mx-auto" style="max-width: 400px;">
                <h3 class="h5 text-center mb-3">Alterar Senha</h3>
                <form id="change-password-form">
                    <div class="mb-3 password-container" id="current-password-container"> 
                        <input type="password" id="current-password" class="form-control" placeholder="Senha Atual" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('current-password')">üëÅÔ∏è</span>
                    </div>
                    <div class="mb-3 password-container">
                        <input type="password" id="new-password" class="form-control" placeholder="Nova Senha" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('new-password')">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="btn btn-outline-dark w-100">Alterar Senha</button>
                </form>
                <div id="password-message" class="message"></div>
            </div>
            <hr class="my-4">
            <div id="purchase-history" class="mt-4">
                <h3 class="h5 text-center mb-3">üßæ Hist√≥rico de Compras</h3>
                <div id="purchase-list" class="list-group"></div>
            </div>
        </div>

        <div id="checkout-section" class="section bg-light text-center">
            <div class="d-flex flex-column justify-content-center align-items-center min-vh-100 pt-5 pb-5"> 
                <div class="p-5 bg-success text-white rounded-4 shadow-lg" style="max-width: 800px; width: 90%;">
                    <h2 class="h1 fw-bold">Compra Finalizada üéâ</h2>
                    <p class="lead mt-3">Obrigado por sua compra! Seu pedido foi processado com sucesso.</p>
                    <p class="mt-4">Um e-mail de confirma√ß√£o ser√° enviado para <span id="account-email-checkout" class="fw-bold">seu e-mail</span>.</p>
                </div>
            </div>
        </div>
        </div>
    
    <footer class="bg-dark text-white-50 mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Minha Loja Online. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // LISTA DE PRODUTOS
        const products = [
            { id: 1, name: 'Notebook Pro', price: 2500.00, image: 'notebook.jpg' },
            { id: 2, name: 'Fone de Ouvido sem Fio', price: 350.50, image: 'fone.jpg' },
            { id: 3, name: 'Rel√≥gio Inteligente', price: 800.00, image: 'relogio.jpg' },
            { id: 4, name: 'Kit de Canetas', price: 45.90, image: 'canetas.jpg' },
            { id: 5, name: 'Planta Decorativa', price: 120.00, image: 'planta.jpg' },
            { id: 6, name: 'Livro de Programa√ß√£o', price: 75.00, image: 'livro.jpg' },
        ];
        
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

        const productListEl = document.getElementById('product-list');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total');
        const cartCountEl = document.getElementById('cart-count');
        const swiperContainer = document.querySelector('.swiper-container');
        
        const sections = {
            products: document.getElementById('products-section'),
            cart: document.getElementById('cart-section'),
            login: document.getElementById('login-section'),
            register: document.getElementById('register-section'),
            account: document.getElementById('account-section'),
            checkout: document.getElementById('checkout-section')
        };
        
        const showCartBtn = document.getElementById('show-cart-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showAccountBtn = document.getElementById('show-account-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const loginMessageEl = document.getElementById('login-message');
        const registerMessageEl = document.getElementById('register-message');
        const passwordMessageEl = document.getElementById('password-message');
        const accountNameEl = document.getElementById('account-name');
        const accountEmailEl = document.getElementById('account-email');
        const purchaseListEl = document.getElementById('purchase-list');
        const accountEmailCheckoutEl = document.getElementById('account-email-checkout');

        // SELETORES PARA OS BOT√ïES CONTROLADOS PELO reCAPTCHA
        const submitLoginBtn = document.getElementById('submit-login-btn');
        const googleLoginContainer = document.getElementById('google-login-container');


        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            sections[sectionName].classList.add('active');

            if (sectionName === 'products') {
                swiperContainer.classList.add('active');
            } else {
                swiperContainer.classList.remove('active');
            }
        }
        
        function renderProducts() {
            productListEl.innerHTML = '';
            products.forEach(product => {
                const productCol = document.createElement('div');
                productCol.className = 'col'; 
                productCol.innerHTML = `
                    <div class="card h-100 rounded-4 shadow-sm product-card-custom">
                        <img src="images/${product.image}" class="card-img-top" alt="${product.name}">
                        <div class="card-body d-flex flex-column text-center">
                            <h3 class="card-title h5 fw-bold text-dark">${product.name}</h3>
                            <p class="card-text fs-5 text-success fw-bold">R$ ${product.price.toFixed(2)}</p>
                            <button class="btn btn-dark mt-auto shadow-sm" onclick="addToCart(${product.id})">
                                <i class="bi bi-cart"></i> Comprar
                            </button>
                        </div>
                    </div>
                `;
                productListEl.appendChild(productCol);
            });
        }
        
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        function updateCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<div class="alert alert-warning text-center m-3">Seu carrinho est√° vazio. Adicione alguns produtos!</div>';
            }
            
            cart.forEach(item => {
                total += item.price * item.quantity;
                const cartItem = document.createElement('div');
                cartItem.className = 'list-group-item d-flex justify-content-between align-items-center p-3'; 
                cartItem.innerHTML = `
                    <div class="flex-grow-1">
                        <h4 class="mb-1 h6 fw-bold">${item.name}</h4>
                        <small class="text-muted">Quant: ${item.quantity}</small>
                        <p class="mb-0 fw-bold text-dark">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="removeFromCart(${item.id})">Remover</button>
                `;
                cartItemsEl.appendChild(cartItem);
            });
            
            cartTotalEl.textContent = total.toFixed(2);
            cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function savePurchase() {
            if (!loggedInUser) return;
            const purchases = JSON.parse(localStorage.getItem('purchases')) || {};
            const userEmailKey = loggedInUser.email; 
            const userPurchases = purchases[userEmailKey] || [];
            
            const newPurchase = {
                id: Date.now(),
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                items: cart,
                date: new Date().toLocaleString()
            };
            
            userPurchases.push(newPurchase);
            purchases[userEmailKey] = userPurchases;
            localStorage.setItem('purchases', JSON.stringify(purchases));
        }

        // FUN√á√ÉO DE RENDERIZA√á√ÉO DA P√ÅGINA DA CONTA (CORRIGIDA)
        function renderAccountPage() {
            if (!loggedInUser) return;
            accountNameEl.textContent = loggedInUser.name;
            accountEmailEl.textContent = loggedInUser.email;
            accountEmailCheckoutEl.textContent = loggedInUser.email; 

            // --- NOVA L√ìGICA DE SENHA PARA GOOGLE LOGIN ---
            const currentPasswordContainer = document.getElementById('current-password-container');
            const currentPasswordField = document.getElementById('current-password');
            const newPasswordField = document.getElementById('new-password');

            // Se a conta for Google E N√ÉO tiver senha definida (password √© null)
            if (loggedInUser.google && !loggedInUser.password) {
                if (currentPasswordContainer) {
                    currentPasswordContainer.style.display = 'none'; // Esconde o campo "Senha Atual"
                    currentPasswordField.removeAttribute('required'); // Remove a obrigatoriedade
                }
                newPasswordField.placeholder = 'Defina sua Nova Senha';
                
                // Altera o t√≠tulo da sec√ß√£o
                document.querySelector('#change-password-section h3').textContent = 'Definir Senha de Acesso';
                passwordMessageEl.innerHTML = `<div class="alert alert-info text-center m-0">Como √© um login Google, defina uma senha para usar o acesso padr√£o.</div>`;

            } else {
                if (currentPasswordContainer) {
                    currentPasswordContainer.style.display = 'block'; // Mostra o campo "Senha Atual"
                    currentPasswordField.setAttribute('required', 'required'); // Volta a obrigatoriedade
                }
                newPasswordField.placeholder = 'Nova Senha';
                document.querySelector('#change-password-section h3').textContent = 'Alterar Senha';
                passwordMessageEl.innerHTML = ''; // Limpa a mensagem se n√£o for o caso Google
            }
            // ---------------------------------------------
            
            const purchases = JSON.parse(localStorage.getItem('purchases')) || {};
            const userPurchases = purchases[loggedInUser.email] || [];
            
            purchaseListEl.innerHTML = '';
            if (userPurchases.length > 0) {
                userPurchases.sort((a, b) => b.id - a.id); 
                userPurchases.forEach(purchase => {
                    const purchaseEl = document.createElement('div');
                    purchaseEl.className = 'list-group-item list-group-item-action mb-3 rounded-3 shadow-sm';
                    const itemsList = purchase.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                    purchaseEl.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1 text-primary">Pedido #${purchase.id}</h5>
                            <small class="text-muted">${purchase.date}</small>
                        </div>
                        <p class="mb-1 text-muted">Itens: ${itemsList}</p>
                        <p class="mb-0 fs-5 fw-bold text-success text-end">Total: R$ ${purchase.total.toFixed(2)}`;
                    purchaseListEl.appendChild(purchaseEl);
                });
            } else {
                purchaseListEl.innerHTML = '<div class="alert alert-info text-center">Nenhuma compra encontrada.</div>';
            }
        }
        
        // FUN√á√ÉO loginUser CORRIGIDA (CORRE√á√ÉO 3.1)
        function loginUser(email, password) {
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                // Se a conta existe E foi criada pelo Google E AINDA N√ÉO TEM senha (password: null)
                // For√ßamos o login Google, j√° que n√£o temos a senha dele no nosso sistema.
                // Mas se ele definiu uma senha, 'user.password' n√£o √© null, e o login deve prosseguir.
                if (user.google && !user.password) { 
                    loginMessageEl.innerHTML = `<div class="error">Por favor, use o bot√£o do Google para entrar ou defina uma senha na sua conta.</div>`;
                    return;
                }

                loggedInUser = user;
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                loginMessageEl.innerHTML = `<div class="success">Bem-vindo, ${user.name}!</div>`;
                updateNavButtons();
                setTimeout(() => { showSection('products'); loginMessageEl.innerHTML = ''; }, 1500);
            } else {
                loginMessageEl.innerHTML = `<div class="error">E-mail ou senha incorretos.</div>`;
            }
        }

        // FUN√á√ÉO registerUser CORRIGIDA (CORRE√á√ÉO 2)
        function registerUser(name, email, password) {
            if (password.length < 6) { 
                registerMessageEl.innerHTML = `<div class="error">A senha deve ter pelo menos 6 caracteres.</div>`;
                return;
            }

            const userExists = users.find(u => u.email === email);
            if (userExists) {
                registerMessageEl.innerHTML = `<div class="error">E-mail j√° cadastrado.</div>`;
            } else {
                const newUser = { name, email, password, google: false };
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                registerMessageEl.innerHTML = `<div class="success">Cadastro realizado! Fa√ßa login para continuar.</div>`;
                setTimeout(() => { showSection('login'); registerMessageEl.innerHTML = ''; }, 2000);
            }
        }

        // FUN√á√ÉO changePassword CORRIGIDA (CORRE√á√ÉO 3.3)
        function changePassword(currentPassword, newPassword) {
            if (!loggedInUser) return;

            // Valida√ß√£o de seguran√ßa m√≠nima (6 caracteres)
            if (newPassword.length < 6) { 
                passwordMessageEl.innerHTML = `<div class="error">A nova senha deve ter pelo menos 6 caracteres.</div>`;
                return;
            }
            
            // L√≥gica para Utilizadores Google que AINDA N√ÉO t√™m senha definida (password: null)
            if (loggedInUser.google && !loggedInUser.password) {
                
                loggedInUser.password = newPassword; // Define a nova senha
                // Mant√©m 'google: true'. Agora ele pode usar ambos os logins.
                passwordMessageEl.innerHTML = `<div class="success">Senha de acesso definida com sucesso! Voc√™ pode usar o login tradicional.</div>`;
                
            } else {
                // L√≥gica para Utilizadores Padr√£o OU Utilizadores Google que J√Å t√™m senha
                if (loggedInUser.password !== currentPassword) {
                    passwordMessageEl.innerHTML = `<div class="error">Senha atual incorreta.</div>`;
                    return;
                }
                loggedInUser.password = newPassword;
                passwordMessageEl.innerHTML = `<div class="success">Senha alterada com sucesso!</div>`;
            }
            
            // L√≥gica Comum para Salvar (usa loggedInUser.google e .password)
            const userIndex = users.findIndex(u => u.email === loggedInUser.email);
            if (userIndex > -1) {
                users[userIndex].password = loggedInUser.password;
                users[userIndex].google = loggedInUser.google; // Atualiza o status Google tamb√©m
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
                
                // Limpar os campos do formul√°rio ap√≥s sucesso
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                
                // Re-renderiza a p√°gina para mostrar as mudan√ßas (campo Senha Atual deve aparecer)
                renderAccountPage(); 
            }
        }


        function updateNavButtons() {
            if (loggedInUser) {
                showLoginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
                showAccountBtn.style.display = 'inline';
            } else {
                showLoginBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
                showAccountBtn.style.display = 'none';
            }
            renderAccountPage();
        }

        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
        }

        // FUN√á√ÉO handleCredentialResponse CORRIGIDA (CORRE√á√ÉO 3.2)
        function handleCredentialResponse(response) {
            const userObject = jwt_decode(response.credential);
            
            let user = users.find(u => u.email === userObject.email);
            
            if (user) {
                // Se o utilizador j√° existe (com ou sem senha), simplesmente garantimos que
                // ele pode usar o login Google, atualizando 'google: true'.
                user.google = true; 
            } else {
                // Novo utilizador via Google (sem senha por padr√£o)
                user = { name: userObject.name, email: userObject.email, password: null, google: true };
                users.push(user);
            }
            
            // AQUI, atualizamos o utilizador na lista global.
            const userIndex = users.findIndex(u => u.email === user.email);
            if (userIndex > -1) {
                users[userIndex] = user; 
            }
            
            localStorage.setItem('users', JSON.stringify(users)); // Salva a atualiza√ß√£o

            loggedInUser = user;
            localStorage.setItem('loggedInUser', JSON.stringify(loggedInUser));
            
            loginMessageEl.innerHTML = `<div class="success">Bem-vindo, ${user.name}!</div>`;
            updateNavButtons();
            setTimeout(() => { showSection('products'); loginMessageEl.innerHTML = ''; }, 1500);
        }
        
        function jwt_decode(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        /* *** FUN√á√ÉO buildEmailTemplate REMOVIDA ***
        // A fun√ß√£o buildEmailTemplate foi movida para o backend (api/send-email.js)
        */

        // FUN√á√ïES DE BLOQUEIO/DESBLOQUEIO DO LOGIN
        function enableLoginButtons() {
            submitLoginBtn.disabled = false;
            googleLoginContainer.style.pointerEvents = 'auto';
            googleLoginContainer.style.opacity = '1';
            loginMessageEl.innerHTML = ''; 
        }

        function disableLoginButtons() {
            submitLoginBtn.disabled = true;
            googleLoginContainer.style.pointerEvents = 'none';
            googleLoginContainer.style.opacity = '0.6';
        }

        
        // Event Listeners (Tratadores de Eventos)
        showCartBtn.addEventListener('click', () => { updateCart(); showSection('cart'); });
        showLoginBtn.addEventListener('click', () => showSection('login'));
        showAccountBtn.addEventListener('click', () => {
            if (loggedInUser) {
                renderAccountPage();
                showSection('account');
            } else {
                alert('Voc√™ precisa estar logado para ver a sua conta!');
                showSection('login');
            }
        });
        logoutBtn.addEventListener('click', () => {
            loggedInUser = null;
            localStorage.removeItem('loggedInUser');
            updateNavButtons();
            alert('Voc√™ saiu da sua conta.');
            showSection('products');
        });
        showRegisterBtn.addEventListener('click', () => showSection('register'));
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = e.target.querySelector('#login-email').value;
            const password = e.target.querySelector('#login-password').value;
            const recaptchaResponse = grecaptcha.getResponse();

            if (!recaptchaResponse) {
                loginMessageEl.innerHTML = `<div class="error">Por favor, resolva o "N√£o sou um rob√¥".</div>`;
                return;
            }
            
            loginUser(email, password);
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target.querySelector('#register-name').value;
            const email = e.target.querySelector('#register-email').value;
            const password = e.target.querySelector('#register-password').value;

            registerUser(name, email, password);
        });

        changePasswordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = e.target.querySelector('#current-password').value;
            const newPassword = e.target.querySelector('#new-password').value;
            changePassword(currentPassword, newPassword);
        });

        // ----------------------------------------------------
        // NOVO BLOCO DO CHECKOUT COM CHAMADA PARA O BACK-END VERCEL
        // ----------------------------------------------------
        checkoutBtn.addEventListener('click', async () => {
            if (cart.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            if (!loggedInUser) {
                alert('Voc√™ precisa estar logado para finalizar a compra!');
                showSection('login');
                return;
            }

            try {
                // Prepara os dados que ser√£o enviados para a Serverless Function
                const checkoutData = {
                    user: {
                        name: loggedInUser.name,
                        email: loggedInUser.email
                    },
                    cart: cart.map(item => ({ // Envia apenas dados essenciais do carrinho
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    }))
                };

                // Chamada HTTP para a Serverless Function /api/send-email
                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkoutData)
                });

                if (response.ok) {
                    console.log('E-MAIL ENVIADO com sucesso (via Back-End Vercel)!');
                    // Continua com a l√≥gica de sucesso
                } else {
                    const errorData = await response.json();
                    console.error('ERRO AO ENVIAR E-MAIL (Front-End):', errorData.error || response.statusText);
                    alert(`Compra finalizada, mas houve um erro ao enviar o e-mail de confirma√ß√£o. Detalhe: ${errorData.error || 'Erro desconhecido.'}`);
                    // NOTA: O fluxo de compra continua mesmo com erro de e-mail.
                }
                
            } catch (error) {
                console.error('ERRO DE CONEX√ÉO AO ENVIAR E-MAIL:', error);
                alert('Compra finalizada, mas houve um erro de conex√£o ao tentar enviar o e-mail.');
            } finally {
                // L√≥gica de Finaliza√ß√£o (ocorre independentemente do sucesso do e-mail)
                savePurchase();
                cart = [];
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCart();
                showSection('checkout');
            }
        });
        // ----------------------------------------------------
        // FIM DO NOVO BLOCO DO CHECKOUT
        // ----------------------------------------------------

        // Inicializa√ß√£o
        function initializeApp() {
            renderProducts();
            updateCart();
            updateNavButtons();
            
            // Inicializa√ß√£o do Swiper CORRIGIDA
            new Swiper(".mySwiper", {
                direction: "horizontal",
                loop: true,
                autoplay: {
                    delay: 4000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: ".swiper-pagination",
                    clickable: true,
                },
                navigation: {
                    nextEl: ".swiper-button-next",
                    prevEl: ".swiper-button-prev",
                },
            });

            // GARANTINDO O BLOQUEIO INICIAL DOS BOT√ïES DE LOGIN
            disableLoginButtons();

            // Garante que a se√ß√£o de produtos √© a inicial
            showSection('products'); 
        }

        initializeApp();
    </script>
</body>
</html>