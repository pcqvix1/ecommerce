<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - E-commerce Elegante</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        body {
            /* Fundo mais moderno com suave degrad√™ */
            background: linear-gradient(180deg, #f4f7fb 0%, #e9f2ff 100%);
            color: #1f2937;
        }
        /* Garantindo que apenas a se√ß√£o ativa apare√ßa */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Ajustes no Swiper */
        .swiper-container {
            display: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .swiper-container.active {
            display: block;
        }
        .swiper {
            width: 100%;
            height: 400px; /* Altura do Carrossel */
        }
        /* AJUSTE MAIS DETALHADO PARA O SWIPER */
        .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem cubra todo o slide sem distor√ß√£o */
        }
        
        /* Estiliza√ß√£o Avan√ßada para os Cards de Produto */
        .product-card-custom {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
        }
        .product-card-custom:hover {
            transform: translateY(-8px); /* Efeito de eleva√ß√£o */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important; /* Sombra mais destacada */
        }
        .product-card-custom .card-img-top {
            height: 220px;
            object-fit: cover;
        }

        /* Bot√£o 'Adicionar ao carrinho' estilizado e feedback */
        .btn-add-to-cart {
            background: linear-gradient(180deg,#0b7285 0%, #055a72 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .btn-add-to-cart:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(2,6,23,0.12); }
        .btn-add-to-cart:active { transform: translateY(0); }
        .btn-add-to-cart .bi { font-size: 1.05rem; }

        .btn-added {
            background: linear-gradient(180deg,#16a34a 0%, #15803d 100%) !important;
            color: #fff !important;
            box-shadow: 0 8px 18px rgba(16,185,129,0.18) !important;
        }

        /* Pulso no contador do carrinho */
        .cart-count-pulse {
            animation: cartPulse 520ms ease-in-out;
        }
        @keyframes cartPulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.45); }
            100% { transform: scale(1); }
        }

        /* Ajuste para o √≠cone de senha - CORRE√á√ÉO 1 APLICADA AQUI */
        .password-container {
            position: relative;
        }
        .password-toggle-icon {
            /* Posi√ß√£o ajustada para alinhar no centro vertical do campo de input */
            position: absolute;
            right: 12px;
            top: 60%; /* Ajuste para melhor alinhamento com o input e a label */
            transform: translateY(-50%); 
            cursor: pointer;
            color: #aaa;
            z-index: 10;
        }

        /* Estilos de mensagens */
        .message {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .google-btn-container {
            /* Alterado: Adicionada flexbox para centralizar o bot√£o oficial do Google */
            padding-top: 10px;
        }
        /* Bot√£o Google customizado (usamos o render do Google dentro do cont√™iner) */
        /* Removido bot√£o customizado do Google para usar o bot√£o padr√£o renderizado pela biblioteca */
        
        /* --- CORRE√á√ïES DOS ESTILOS DA NAVBAR (APENAS COPIADO, SEM MUDAN√áAS) --- */
        
        /* Estilo Base: Garante que os bot√µes OUTLINE tenham texto claro na navbar escura */
        .navbar .btn-outline-primary,
        .navbar .btn-outline-light {
            border-color: #f0f2f5; /* Borda clara */
            color: #f0f2f5 !important; /* Cor do texto clara para contraste */
        }

        /* Base style para Sair */
        .navbar .btn-outline-danger {
            color: #f0f2f5 !important;
            border-color: #f0f2f5;
        }

        /* --- Ajuste do hover para ter as cores espec√≠ficas do Bootstrap --- */

        /* Login (Primary) Hover: Fica azul (cor prim√°ria) com texto branco */
        .navbar .btn-outline-primary:hover {
            background-color: #0d6efd; /* Cor azul primary do Bootstrap */
            color: white !important; 
            border-color: #0d6efd;
        }

        /* Minha Conta (Light) Hover: Fica claro com texto escuro */
        .navbar .btn-outline-light:hover {
            background-color: #f8f9fa; /* Cor clara light do Bootstrap */
            color: #1a1a1a !important; /* Texto escuro para contraste */
            border-color: #f8f9fa;
        }

        /* Sair (Danger) Hover: Fica vermelho (cor danger) com texto branco */
        .navbar .btn-outline-danger:hover {
            background-color: #dc3545; /* Cor vermelha danger do Bootstrap */
            color: white !important; 
            border-color: #dc3545;
        }
        
        /* Garante que o bot√£o de Sucesso (Carrinho) mant√©m o contraste */
        .navbar .btn-success {
            background-color: #28a745; 
            border-color: #28a745;
            color: white !important;
        }
        /* Nova paleta para a navbar: azul profundo com leve brilho */
        .navbar-custom {
            background: linear-gradient(90deg,#0f172a 0%, #0b4f6c 100%);
        }
        
        /* --- FIM DOS AJUSTES --- */
    </style>
</head>
<body>

    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top shadow-lg">
            <div class="container-fluid container-lg">
                <a class="navbar-brand fw-bold fs-4 text-white" href="#" onclick="showSection('products'); return false;">Minha Loja Online</a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <button class="btn btn-success nav-link text-white mx-1 my-1 my-lg-0 position-relative" id="show-cart-btn">
                            <i class="bi bi-cart"></i> Carrinho 
                            <span class="badge bg-danger ms-1" id="cart-count">0</span>
                        </button>
                        
                        <button class="btn btn-outline-primary nav-link mx-1 my-1 my-lg-0" id="show-login-btn">Login</button>
                        <button class="btn btn-outline-light nav-link mx-1 my-1 my-lg-0" id="show-account-btn" style="display:none;">Minha Conta</button>
                        <button class="btn btn-outline-danger nav-link mx-1 my-1 my-lg-0" id="logout-btn" style="display:none;">Sair</button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container my-5">
        
        <div class="swiper-container active mb-5">
            <div class="swiper mySwiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide"><img src="images/livro.jpg" alt="Livro" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/canetas.jpg" alt="Canetas" class="img-fluid"></div>
                    <div class="swiper-slide"><img src="images/relogio.jpg" alt="Rel√≥gio" class="img-fluid"></div>
                </div>
                <div class="swiper-pagination"></div>

                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>

        <div id="products-section" class="section active p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">‚ú® Destaques e Produtos</h2>
            <div id="product-list" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-5">
                </div>
        </div>

        <div id="cart-section" class="section p-4 bg-white rounded-4 shadow-lg">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light">üõí Seu Carrinho</h2>
            <div id="cart-items" class="list-group list-group-flush border rounded-3">
                </div>
            <div id="cart-total-container" class="mt-4 p-3 border-top text-end bg-light rounded-bottom">
                <span class="fs-4 fw-bold text-dark">TOTAL: R$<span id="cart-total" class="text-success">0.00</span></span>
            </div>
            <button id="checkout-btn" class="btn btn-success btn-lg w-100 mt-3 shadow">Finalizar Compra</button>
        </div>

        <div id="login-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üîê Acesso √† Conta</h2>
            <form id="login-form" class="mx-auto">
                <div class="mb-3">
                    <label for="login-email" class="form-label">E-mail</label>
                    <input type="email" id="login-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="login-password" class="form-label">Senha</label>
                    <input type="password" id="login-password" class="form-control form-control-lg" placeholder="********" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('login-password')">üëÅÔ∏è</span>
                </div>
                <div class="mb-3 d-flex justify-content-center">
                    <div class="g-recaptcha" data-sitekey="6LcJrfArAAAAACRFhgeun6wDEA6AyEJ6IvCaX9SE"
                         data-callback="enableLoginButtons"
                         data-expired-callback="disableLoginButtons">
                    </div>
                </div>
                <button type="submit" id="submit-login-btn" class="btn btn-dark w-100 btn-lg shadow-sm" disabled>Entrar</button>
            </form>
            <div class="my-3 text-center text-muted">ou</div>
            
            <div class="google-btn-container d-flex justify-content-center" id="google-login-container">
                <div id="g_id_onload"
                    data-client_id="413829830677-b0q7j33043556os7iertf9b9ij9gbvbi.apps.googleusercontent.com"
                    data-callback="handleCredentialResponse"
                    data-ux_mode="popup"
                    data-auto_select="false"
                    data-context="signin">
                </div>
                
                <div class="g_id_signin"
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="signin_with"
                     data-shape="pill"
                     data-logo_alignment="left">
                </div>
            </div>
            <p class="text-center mt-4 text-muted">Novo por aqui? <button id="show-register-btn" class="btn btn-link p-0 fw-bold align-baseline text-primary">Crie sua Conta</button></p>
            <div id="login-message" class="message"></div>
        </div>

        <div id="register-section" class="section p-5 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 500px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üìù Cadastro R√°pido</h2>
            <form id="register-form" class="mx-auto">
                <div class="mb-3">
                    <label for="register-name" class="form-label">Nome Completo</label>
                    <input type="text" id="register-name" class="form-control form-control-lg" placeholder="Seu nome" required>
                </div>
                <div class="mb-3">
                    <label for="register-email" class="form-label">E-mail</label>
                    <input type="email" id="register-email" class="form-control form-control-lg" placeholder="seu.email@exemplo.com" required>
                </div>
                <div class="mb-3 password-container">
                    <label for="register-password" class="form-label">Senha</label>
                    <input type="password" id="register-password" class="form-control form-control-lg" placeholder="Crie uma senha forte" required>
                    <span class="password-toggle-icon" onclick="togglePasswordVisibility('register-password')">üëÅÔ∏è</span>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg shadow-sm">Cadastrar</button>
            </form>
            <div id="register-message" class="message"></div>
        </div>

        <div id="account-section" class="section p-4 bg-white rounded-4 shadow-lg mx-auto" style="max-width: 800px;">
            <h2 class="pb-3 mb-4 border-bottom text-dark fw-light text-center">üë§ Minha Conta</h2>
            <div id="account-details" class="text-center mb-4 p-3 bg-light rounded-3">
                <h3 class="h5 fw-bold text-primary">Detalhes Pessoais</h3>
                <p class="mb-1 text-start"><strong>Nome:</strong> <span id="account-name"></span></p>
                <p class="mb-0 text-start"><strong>E-mail:</strong> <span id="account-email"></span></p>
            </div>
            <hr class="my-4">
            <div id="change-password-section" class="mt-4 p-3 border rounded-3 mx-auto" style="max-width: 400px;">
                <h3 class="h5 text-center mb-3">Alterar Senha</h3>
                <form id="change-password-form">
                    <div class="mb-3 password-container" id="current-password-container"> 
                        <input type="password" id="current-password" class="form-control" placeholder="Senha Atual" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('current-password')">üëÅÔ∏è</span>
                    </div>
                    <div class="mb-3 password-container">
                        <input type="password" id="new-password" class="form-control" placeholder="Nova Senha" required>
                        <span class="password-toggle-icon" onclick="togglePasswordVisibility('new-password')">üëÅÔ∏è</span>
                    </div>
                    <button type="submit" class="btn btn-outline-dark w-100">Alterar Senha</button>
                </form>
                <div id="password-message" class="message"></div>
            </div>
            <hr class="my-4">
            <div id="purchase-history" class="mt-4">
                <h3 class="h5 text-center mb-3">üßæ Hist√≥rico de Compras</h3>
                <div id="purchase-list" class="list-group"></div>
            </div>
        </div>

        <div id="checkout-section" class="section bg-light text-center">
            <div class="d-flex flex-column justify-content-center align-items-center min-vh-100 pt-5 pb-5"> 
                <div class="p-5 bg-success text-white rounded-4 shadow-lg" style="max-width: 800px; width: 90%;">
                    <h2 class="h1 fw-bold">Compra Finalizada üéâ</h2>
                    <p class="lead mt-3">Obrigado por sua compra! Seu pedido foi processado com sucesso.</p>
                    <p class="mt-4">Um e-mail de confirma√ß√£o ser√° enviado para <span id="account-email-checkout" class="fw-bold">seu e-mail</span>.</p>
                    <p class="mt-3 text-warning fw-bold">(ATEN√á√ÉO: Este √© apenas um site de demonstra√ß√£o/brincadeira. Nenhum produto ser√° enviado e nenhuma compra √© real)</p>
                </div>
            </div>
        </div>
        </div>
    
    <footer class="bg-dark text-white-50 mt-5 py-4">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 Minha Loja Online. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
    // URL da API
    const API_BASE_URL = window.location.origin;
    const API_USERS_ENDPOINT = API_BASE_URL + '/api/users';
    const API_PURCHASES_ENDPOINT = API_BASE_URL + '/api/purchases';

    // Lista de produtos (MANTIDO)
    const products = [
        { id: 1, name: 'Canetas (Kit 10)', price: 12.99, image: 'canetas.jpg', description: 'Kit com 10 canetas esferogr√°ficas coloridas.' },
        { id: 2, name: 'Caderno A5', price: 25.50, image: 'caderno.jpg', description: 'Caderno pautado A5 com capa dura.' },
        { id: 3, name: 'Mochila Elegante', price: 150.00, image: 'mochila.jpg', description: 'Mochila preta com design moderno e compartimento para notebook.' },
        { id: 4, name: 'Marcadores de Texto (Kit 6)', price: 18.00, image: 'marcadores.jpg', description: 'Kit com 6 marcadores de texto em cores neon.' },
        { id: 5, name: 'Planner Semanal', price: 35.90, image: 'planner.jpg', description: 'Planner n√£o datado para organiza√ß√£o semanal.' },
        { id: 6, name: 'Garrafa T√©rmica', price: 55.00, image: 'garrafa.jpg', description: 'Garrafa t√©rmica de 500ml em a√ßo inoxid√°vel.' }
    ];

    // Vari√°veis de estado
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

    // --- UTILS ---

    // Fun√ß√£o para mostrar a se√ß√£o correta
    function showSection(sectionId) {
        document.querySelectorAll('main section').forEach(section => {
            section.classList.add('d-none');
        });
        document.getElementById(sectionId + 'Section').classList.remove('d-none');
    }

    // Formata valor para BRL
    const formatBRL = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

    // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---

    // Renderiza a lista de produtos
    function renderProducts() {
        const productListEl = document.getElementById('productList');
        productListEl.innerHTML = '';
        products.forEach(product => {
            productListEl.innerHTML += `
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-sm h-100 product-card">
                        <img src="${product.image}" class="card-img-top" alt="${product.name}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="card-text text-muted">${product.description}</p>
                            <p class="card-text fw-bold mt-auto">${formatBRL(product.price)}</p>
                            <button class="btn btn-primary add-to-cart-btn" data-product-id="${product.id}">
                                <i class="bi bi-cart-plus me-2"></i>Adicionar ao Carrinho
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // Atualiza a visualiza√ß√£o do carrinho e o badge do NavBar
    function updateCart() {
        const cartItemsEl = document.getElementById('cartItems');
        const cartTotalEl = document.getElementById('cartTotal');
        const cartBadgeEl = document.getElementById('cartBadge');
        const cartSectionEl = document.getElementById('cartSection');
        const cartCheckoutBtn = document.getElementById('goToCheckoutBtn');
        
        cartItemsEl.innerHTML = '';
        let total = 0;
        let totalItems = 0;

        cart.forEach(item => {
            total += item.price * item.quantity;
            totalItems += item.quantity;
            cartItemsEl.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge text-bg-primary rounded-pill me-2">${item.quantity}</span>
                        ${item.name}
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="me-3">${formatBRL(item.price * item.quantity)}</span>
                        <button class="btn btn-sm btn-outline-danger remove-from-cart-btn" data-product-id="${item.id}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </li>
            `;
        });

        cartTotalEl.textContent = formatBRL(total);
        cartBadgeEl.textContent = totalItems;
        
        // Ativar/Desativar bot√£o de checkout e mensagem de carrinho vazio
        if (cart.length === 0) {
            cartSectionEl.querySelector('.alert').classList.remove('d-none');
            cartCheckoutBtn.disabled = true;
        } else {
            cartSectionEl.querySelector('.alert').classList.add('d-none');
            cartCheckoutBtn.disabled = false;
        }

        // Salva no localStorage
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    // Atualiza os bot√µes de navega√ß√£o (Login/Conta)
    function updateNavButtons() {
        const loginBtn = document.getElementById('loginBtn');
        const accountBtn = document.getElementById('accountBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const welcomeMessageEl = document.getElementById('welcomeMessage');

        loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));

        if (loggedInUser) {
            loginBtn.classList.add('d-none');
            accountBtn.classList.remove('d-none');
            logoutBtn.classList.remove('d-none');
            welcomeMessageEl.textContent = `Ol√°, ${loggedInUser.name || loggedInUser.email}!`;
            showSection('products'); // Volta para produtos se logar
            
            // Renderiza os dados da conta
            renderAccountDetails();

        } else {
            loginBtn.classList.remove('d-none');
            accountBtn.classList.add('d-none');
            logoutBtn.classList.add('d-none');
            welcomeMessageEl.textContent = '';
            
            // Limpa a se√ß√£o de conta
            document.getElementById('accountDetails').innerHTML = '';
            document.getElementById('purchaseHistory').innerHTML = '';
        }
    }

    // Desabilita os bot√µes de login at√© o reCAPTCHA carregar
    function disableLoginButtons() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        if (loginForm) loginForm.querySelector('button[type="submit"]').disabled = true;
        if (registerForm) registerForm.querySelector('button[type="submit"]').disabled = true;

        // Bot√£o Google GSI n√£o precisa ser desabilitado se estiver usando o widget padr√£o.
    }
    
    // --- FUN√á√ïES DE CONTA E HIST√ìRICO ---

    // Pega o hist√≥rico de compras do backend
    async function fetchPurchaseHistory(email) {
        try {
            const response = await fetch(`${API_PURCHASES_ENDPOINT}?email=${email}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            if (data.success) {
                return data.purchases;
            } else {
                console.error('Erro ao buscar hist√≥rico:', data.message);
                return null;
            }
        } catch (error) {
            console.error('Erro de rede ao buscar hist√≥rico:', error);
            return null;
        }
    }

    // Renderiza a se√ß√£o de hist√≥rico de compras
    async function renderAccountDetails() {
        const accountDetailsEl = document.getElementById('accountDetails');
        const purchaseHistoryEl = document.getElementById('purchaseHistory');
        
        if (!loggedInUser) {
            accountDetailsEl.innerHTML = '';
            purchaseHistoryEl.innerHTML = '';
            return;
        }

        accountDetailsEl.innerHTML = `
            <p><strong>Nome:</strong> ${loggedInUser.name || 'N√£o fornecido'}</p>
            <p><strong>E-mail:</strong> ${loggedInUser.email}</p>
        `;

        // 1. Busca o hist√≥rico
        const history = await fetchPurchaseHistory(loggedInUser.email);
        
        if (!history || history.length === 0) {
            purchaseHistoryEl.innerHTML = '<div class="alert alert-info">Nenhuma compra encontrada no seu hist√≥rico.</div>';
            return;
        }

        // 2. Renderiza o hist√≥rico
        purchaseHistoryEl.innerHTML = history.map(purchase => {
            const date = new Date(purchase.date);
            const formattedDate = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
            
            const itemsList = purchase.items.map(item => 
                `<li>${item.quantity}x ${item.name} (${formatBRL(item.price)})</li>`
            ).join('');

            return `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Compra #${purchase.id} - ${formattedDate}</h6>
                        <p class="card-text fw-bold">Total: ${formatBRL(purchase.total)}</p>
                        <p class="card-text">Itens:</p>
                        <ul class="list-unstyled">${itemsList}</ul>
                    </div>
                </div>
            `;
        }).join('');
    }

    // --- FUN√á√ïES DE CARRINHO ---

    // Adiciona um produto ao carrinho
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (product) {
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCart();
        }
    }

    // Remove um produto do carrinho
    function removeFromCart(productId) {
        const existingItemIndex = cart.findIndex(item => item.id === productId);
        if (existingItemIndex > -1) {
            const existingItem = cart[existingItemIndex];
            if (existingItem.quantity > 1) {
                existingItem.quantity -= 1;
            } else {
                cart.splice(existingItemIndex, 1); // Remove o item se a quantidade for 1
            }
            updateCart();
        }
    }

    // --- FUN√á√ïES DE AUTENTICA√á√ÉO ---

    // Fun√ß√£o de Logout
    function logoutUser() {
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('cart'); // Limpa o carrinho ao sair
        cart = [];
        updateCart();
        updateNavButtons();
        showSection('products');
    }

    // Fun√ß√£o de Login/Registro para ambos os m√©todos (padr√£o e Google)
    // index.html - Fun√ß√£o de Login/Registro para ambos os m√©todos (padr√£o e Google)
// Fun√ß√£o de Login/Registro para ambos os m√©todos (padr√£o e Google)
async function loginUser(email, password, isGoogleLogin = false, name = null) {
    const loginMessageEl = document.getElementById('loginMessage');
    loginMessageEl.innerHTML = '';

    // Monta o corpo base
    let actionBody = {
        action: 'login',
        email: email,
        name: name, // usado no login Google
        recaptcha: window._lastRecaptchaToken
    };

    // ‚úÖ Corre√ß√£o: s√≥ adiciona o campo "password" se for login normal e senha existir
    if (!isGoogleLogin && password) {
        actionBody.password = password;
    }

    try {
        const response = await fetch(API_USERS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(actionBody)
        });

        const data = await response.json();

        if (data.success) {
            const user = data.user;
            localStorage.setItem('loggedInUser', JSON.stringify({ email: user.email, name: user.name }));
            loginMessageEl.innerHTML = `<div class="message success">Login bem-sucedido!</div>`;

            updateNavButtons();
            showSection('products');
        } else {
            loginMessageEl.innerHTML = `<div class="message error">${data.message}</div>`;
        }
    } catch (error) {
        console.error('Erro de rede/servidor:', error);
        loginMessageEl.innerHTML = `<div class="message error">Erro de rede ou servidor ao tentar login.</div>`;
    }
}

    // --- GOOGLE IDENTITY / RECAPTCHA ---

    // Callback para reCAPTCHA (chamado quando o reCAPTCHA √© resolvido)
    window.recaptchaCallback = function(token) {
        window._lastRecaptchaToken = token;
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        if (loginForm) loginForm.querySelector('button[type="submit"]').disabled = false;
        if (registerForm) registerForm.querySelector('button[type="submit"]').disabled = false;
        
        document.getElementById('loginMessage').innerHTML = ''; // Limpa mensagens de erro
        document.getElementById('registerMessage').innerHTML = '';
    }

    // Callback para Login com Google (handleCredentialResponse)
    // O Google executa esta fun√ß√£o automaticamente ap√≥s a intera√ß√£o com o bot√£o.
    window.handleCredentialResponse = function(response) {
        const loginMessageEl = document.getElementById('loginMessage');

        if (!window._lastRecaptchaToken) {
            loginMessageEl.innerHTML = `<div class="alert alert-warning">Falha de seguran√ßa: reCAPTCHA n√£o detectado. Por favor, resolva o reCAPTCHA antes de entrar com Google.</div>`;
            return;
        }

        // Certifique-se de que a biblioteca 'jwt-decode' est√° inclu√≠da no seu projeto
        // ou use a l√≥gica do seu c√≥digo para decodificar o token.
        try {
            const userObject = JSON.parse(atob(response.credential.split('.')[1]));
            
            // Chama loginUser:
            // email: userObject.email
            // password: null (aus√™ncia de senha, for√ßado para o backend)
            // isGoogleLogin: true
            // name: userObject.name
            loginUser(userObject.email, null, true, userObject.name); 

        } catch (e) {
            console.error('Erro ao decodificar token do Google:', e);
            loginMessageEl.innerHTML = `<div class="alert alert-danger">Erro ao processar dados do Google.</div>`;
        }
    }
    
    // --- LISTENERS ---

    // Listener para adicionar ao carrinho
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-to-cart-btn')) {
            const productId = parseInt(e.target.dataset.productId);
            addToCart(productId);
        }
    });

    // Listener para remover do carrinho
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-from-cart-btn')) {
            const productId = parseInt(e.target.dataset.productId);
            removeFromCart(productId);
        }
    });

    // Listener para o formul√°rio de Login Padr√£o
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        loginUser(email, password, false); // isGoogleLogin: false
    });

    // Listener para o formul√°rio de Registro Padr√£o
    document.getElementById('registerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;

        registerUser(name, email, password);
    });

    // Listener para o bot√£o de Logout
    document.getElementById('logoutBtn').addEventListener('click', logoutUser);

    // Listener para finalizar compra
    document.getElementById('finishCheckoutBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        if (!loggedInUser) {
            alert('Voc√™ precisa estar logado para finalizar a compra!');
            return;
        }

        const checkoutMessageEl = document.getElementById('checkoutMessage');
        checkoutMessageEl.innerHTML = '';
        
        // Preparar dados da compra
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const itemsForDB = cart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity
        }));

        const purchaseData = {
            email: loggedInUser.email,
            total: total,
            items: itemsForDB
        };

        // 1. Salvar no Banco de Dados (API /api/purchases)
        try {
            const response = await fetch(API_PURCHASES_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(purchaseData)
            });

            if (!response.ok) {
                // Se a API retornar um 4xx ou 5xx
                const errorData = await response.json();
                throw new Error(errorData.message || `Erro do servidor: ${response.status}`);
            }
            
            const dbData = await response.json();
            console.log('Compra salva no DB (Neon). ID:', dbData.purchaseId);
            
            // 2. Enviar E-mail (API /api/send-email)
            const emailResponse = await fetch(API_BASE_URL + '/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    to_email: loggedInUser.email,
                    to_name: loggedInUser.name,
                    order_total: formatBRL(total),
                    items: itemsForDB
                })
            });

            const emailData = await emailResponse.json();
            
            if (!emailData.messageId) {
                // Se o email falhar mas a compra estiver salva
                throw new Error('E-mail n√£o p√¥de ser enviado, mas a compra foi salva.');
            }

            checkoutMessageEl.innerHTML = `<div class="alert alert-success">Compra finalizada! E-mail de confirma√ß√£o enviado.</div>`;
            console.log('E-MAIL ENVIADO COM SUCESSO! Message ID:', emailData.messageId);

        } catch (error) {
            console.error('ERRO GERAL NO CHECKOUT:', error);
            // Notifica o usu√°rio, mas a compra j√° est√° salva no DB (se o erro foi s√≥ no e-mail)
            checkoutMessageEl.innerHTML = `<div class="alert alert-warning">Ocorreu um erro no checkout: ${error.message}. Por favor, verifique seu e-mail.</div>`;
        }

        // 3. Finalizar a Transa√ß√£o no Frontend
        cart = [];
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCart();
        showSection('checkout');
    });

    // Inicializa√ß√£o
    function initializeApp() {
        renderProducts();
        updateCart();
        updateNavButtons();
        
        // Inicializa√ß√£o do Swiper CORRIGIDA
        new Swiper(".mySwiper", {
            direction: "horizontal",
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            pagination: {
                el: ".swiper-pagination",
                clickable: true,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });

        // GARANTINDO O BLOQUEIO INICIAL DOS BOT√ïES DE LOGIN
        disableLoginButtons();
        
        // REMOVIDO: Toda a l√≥gica de inicializa√ß√£o manual e polling do Google Identity.
        // O bot√£o agora √© inicializado automaticamente via atributos 'data-*' no HTML.

        // Garante que a se√ß√£o de produtos √© a inicial
        showSection('products'); 
    }

    initializeApp();
</script>
</body>
</html>